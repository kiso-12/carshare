<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå¸‚å¤§ãƒ‰ãƒ©ã‚¤ãƒ–GOGO - Ver14.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Leaflet CSS (åœ°å›³ç”¨) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#00A7C7', 
                            dark: '#0089A1',
                        },
                        secondary: '#F5A623',
                        ncu: {
                            green: '#006A5C',
                            yellow: '#FDB813',
                        }
                    },
                },
            },
        };
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', 'sans-serif'; height: 100vh; display: flex; flex-direction: column; }
        main { flex-grow: 1; padding-bottom: 90px; overflow-y: auto; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        #app-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: end; }
        @media (min-width: 640px) { .modal { align-items: center; } }
        
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: white; border-radius: 20px 20px 0 0; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; padding-bottom: 20px;}
        @media (min-width: 640px) { .modal-content { border-radius: 12px; width: 90%; } }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* åœ°å›³ã®é«˜ã•èª¿æ•´ */
        #map-container { height: 250px; z-index: 1; }

        /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼ */
        .schedule-bar { height: 24px; border-radius: 4px; overflow: hidden; display: flex; background: #e5e7eb; position: relative; }
        .schedule-segment { height: 100%; }
        .schedule-segment.booked { background-color: #ef4444; } 
        .schedule-segment.selected { background-color: #3b82f6; opacity: 0.8; } 
        .schedule-label { position: absolute; bottom: -20px; font-size: 10px; color: #6b7280; transform: translateX(-50%); }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .calendar-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 12px; }
        .calendar-cell.today { background-color: #ecfdf5; border: 2px solid #006A5C; font-weight: bold; }
        .status-mark { font-size: 14px; font-weight: bold; margin-top: 2px; }
        .status-ok { color: #00A7C7; } 
        .status-few { color: #F5A623; } 
        .status-full { color: #ef4444; } 

        /* ã‚¯ãƒ¼ãƒãƒ³åˆ¸ã‚¹ã‚¿ã‚¤ãƒ« */
        .coupon-ticket {
            background: radial-gradient(circle at left, transparent 10px, #fff 10px) left,
                        radial-gradient(circle at right, transparent 10px, #fff 10px) right;
            background-size: 51% 100%;
            background-repeat: no-repeat;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        /* ã‚¹ã‚¿ãƒ³ãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        .stamp-cell { position: relative; }
        .stamp-date { font-size: 10px; font-weight: bold; color: #006A5C; margin-top: -4px; background: rgba(255,255,255,0.8); padding: 0 4px; border-radius: 4px; }

        /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
        .overflow-x-auto::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* é€±é–“äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«æ”¹å–„ */
        .weekly-table th, .weekly-table td { padding: 8px 4px; }
        .weekly-table td.status-ok-cell { background-color: #ecfdf5; color: #006A5C; font-weight: bold; }
        .weekly-table td.status-full-cell { background-color: #fef2f2; color: #ef4444; opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="car-front" class="text-ncu-green"></i>
                <div class="text-lg font-bold text-ncu-green tracking-tight">
                    åå¸‚å¤§ãƒ‰ãƒ©ã‚¤ãƒ–<span class="text-secondary">GOGO</span>
                </div>
            </div>
            <button id="login-btn" class="text-sm bg-ncu-green text-white font-semibold px-4 py-2 rounded-full hover:bg-opacity-90 transition shadow-sm">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </nav>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="container mx-auto relative">

        <!-- ç”»é¢ï¼šãƒ›ãƒ¼ãƒ  -->
        <section id="screen-home" class="screen active p-4">
            
            <!-- åˆ©ç”¨ä¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« (åˆæœŸéè¡¨ç¤º) -->
            <div id="active-booking-panel" class="hidden bg-ncu-green text-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-secondary">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold flex items-center"><i data-lucide="key" class="w-5 h-5 mr-2"></i>åˆ©ç”¨ä¸­</h3>
                    <span class="text-xs bg-white text-ncu-green px-2 py-1 rounded font-bold">è¿”å´å¾…ã¡</span>
                </div>
                <p id="active-car-name" class="text-lg font-bold mb-1">è»Šç¨®å</p>
                <p class="text-sm opacity-90 mb-4">çµ‚äº†äºˆå®š: <span id="active-end-time" class="font-mono text-lg">15:00</span></p>
                
                <button onclick="openReturnModal()" class="w-full bg-white text-ncu-green font-bold py-3 rounded-lg shadow hover:bg-gray-100 transition flex items-center justify-center">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                    è¿”å´æ‰‹ç¶šãã¸
                </button>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„1: å”è³›ä¼æ¥­ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã› (ãƒˆãƒƒãƒ—é…ç½®) -->
            <div class="mb-6">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="sparkles" class="w-6 h-6 mr-2 text-secondary"></i>ãŠã™ã™ã‚æƒ…å ±
                    </h3>
                    <button class="text-xs text-primary font-bold" onclick="document.querySelector('[data-screen=screen-news]').click()">ã™ã¹ã¦è¦‹ã‚‹</button>
                </div>
                <!-- æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹ -->
                <div class="flex overflow-x-auto space-x-4 pb-2 no-scrollbar" id="home-news-slider">
                    <!-- JSã§ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„2: ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼é€²æ— -->
            <div class="mb-8">
                <div class="bg-gradient-to-r from-ncu-green to-teal-700 rounded-xl p-4 shadow-lg text-white relative overflow-hidden cursor-pointer hover:opacity-95 transition" onclick="document.querySelector('[data-screen=screen-stamp]').click()">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-white opacity-10 rounded-full transform translate-x-10 -translate-y-10"></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <h3 class="font-bold text-lg mb-1 flex items-center"><i data-lucide="award" class="w-5 h-5 mr-2"></i>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h3>
                            <p class="text-xs opacity-90">ã‚ã¨<span class="font-bold text-lg text-secondary mx-1">7</span>å€‹ã§ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼</p>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-bold">2</span><span class="text-sm opacity-80">/9</span>
                        </div>
                    </div>
                    <div class="w-full bg-black/20 rounded-full h-1.5 mt-3 relative z-10">
                        <div class="bg-secondary h-1.5 rounded-full" style="width: 22%"></div>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs opacity-80">æ¬¡ã®ç›®çš„åœ°ï¼šçŠ¬å±±åŸä¸‹ç”º</span>
                        <span class="text-xs font-bold bg-white/20 px-3 py-1 rounded-full">ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</span>
                    </div>
                </div>
            </div>

            <!-- è»Šä¸¡äºˆç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ä¸‹éƒ¨ã«é…ç½®) -->
            <div id="view-cars" class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i data-lucide="car" class="w-5 h-5 mr-2 text-gray-600"></i>è»Šã§å‡ºã‹ã‘ã‚ˆã†
                </h3>
                
                <!-- ãƒãƒƒãƒ— -->
                <div id="map-container" class="rounded-xl shadow-md overflow-hidden mb-6 border border-gray-200 relative"></div>

                <!-- é€±é–“äºˆç´„çŠ¶æ³ (ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„) -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-gray-600">ä»Šé€±ã®ç©ºãçŠ¶æ³</h4>
                        <button onclick="openMonthlyCalendar()" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full flex items-center transition">
                            <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                        </button>
                    </div>
                    <div class="overflow-x-auto pb-2">
                        <table class="w-full min-w-[350px] text-sm text-center weekly-table">
                            <thead id="weekly-header-row" class="text-gray-500 border-b border-gray-100"></thead>
                            <tbody id="weekly-body-rows" class="text-gray-700"></tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-3 mt-2 text-[10px] text-gray-400">
                        <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-ncu-green mr-1"></span>ä½™è£•ã‚ã‚Š</span>
                        <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-secondary mr-1"></span>æ®‹ã‚Šã‚ãšã‹</span>
                        <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-red-500 mr-1"></span>æº€è»Š</span>
                    </div>
                </div>

                <!-- è»Šä¸¡ãƒªã‚¹ãƒˆ -->
                <div id="car-list-container" class="space-y-4 pb-20"></div>
            </div>
        </section>

        <!-- ç”»é¢ï¼šã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ -->
        <section id="screen-stamp" class="screen p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="award" class="mr-2 text-secondary"></i>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼
            </h2>
            
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h3>
                    <button onclick="openRewardModal()" class="text-xs bg-ncu-green text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-opacity-90 transition">
                        æ™¯å“ä¸€è¦§ã‚’è¦‹ã‚‹
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-3" id="stamp-grid">
                    <!-- JSã§ç”Ÿæˆ -->
                </div>
                <div class="mt-4 text-center">
                    <button class="w-full bg-secondary text-white font-bold py-3 rounded-xl shadow-lg hover:bg-orange-500 transition active:scale-95 flex items-center justify-center space-x-2">
                        <i data-lucide="qr-code"></i>
                        <span>ã‚¹ãƒãƒƒãƒˆã§QRã‚’èª­ã¿å–ã‚‹</span>
                    </button>
                </div>
            </div>

            <div class="mb-20">
                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i data-lucide="map-pin" class="w-5 h-5 mr-2 text-primary"></i>ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆï¼ˆç‰¹å…¸ä»˜ãï¼‰
                </h3>
                <div class="space-y-3" id="route-list">
                    <!-- JSã§ç”Ÿæˆ -->
                </div>
            </div>
        </section>

        <!-- ç”»é¢ï¼šã‚¯ãƒ¼ãƒãƒ³ -->
        <section id="screen-coupon" class="screen p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="ticket" class="mr-2 text-secondary"></i>ãƒã‚¤ã‚¯ãƒ¼ãƒãƒ³
            </h2>
            <div class="flex mb-6 bg-gray-200 p-1 rounded-lg">
                <button class="coupon-tab flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-primary transition" data-target="active-coupons">åˆ©ç”¨å¯èƒ½</button>
                <button class="coupon-tab flex-1 py-2 rounded-md text-sm font-bold text-gray-500 transition" data-target="used-coupons">ä½¿ç”¨æ¸ˆã¿ãƒ»æœŸé™åˆ‡ã‚Œ</button>
            </div>
            <div id="active-coupons" class="space-y-4"></div>
            <div id="used-coupons" class="space-y-4 hidden opacity-60"></div>
        </section>

        <!-- ç”»é¢ï¼šãŠçŸ¥ã‚‰ã› -->
        <section id="screen-news" class="screen p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="bell" class="mr-2 text-secondary"></i>ãŠçŸ¥ã‚‰ã›
            </h2>
            <div class="flex overflow-x-auto space-x-2 mb-4 pb-2 no-scrollbar">
                <button class="news-tab px-4 py-1.5 rounded-full text-sm font-bold bg-ncu-green text-white transition whitespace-nowrap" data-filter="all">ã™ã¹ã¦</button>
                <button class="news-tab px-4 py-1.5 rounded-full text-sm font-bold bg-gray-100 text-gray-500 transition whitespace-nowrap" data-filter="app">ã‚¢ãƒ—ãƒª</button>
                <button class="news-tab px-4 py-1.5 rounded-full text-sm font-bold bg-gray-100 text-gray-500 transition whitespace-nowrap" data-filter="event">ã‚¤ãƒ™ãƒ³ãƒˆ</button>
                <button class="news-tab px-4 py-1.5 rounded-full text-sm font-bold bg-gray-100 text-gray-500 transition whitespace-nowrap" data-filter="coupon">ã‚¯ãƒ¼ãƒãƒ³</button>
            </div>
            <div id="news-list" class="space-y-3 mb-20">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
        </section>

        <!-- ç”»é¢ï¼šãƒã‚¤ãƒšãƒ¼ã‚¸ -->
        <section id="screen-mypage" class="screen p-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 flex items-center space-x-4">
                <div class="bg-gray-100 p-3 rounded-full">
                    <i data-lucide="user" class="w-8 h-8 text-gray-400"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold">åå¸‚å¤§ å¤ªéƒ</h3>
                    <p class="text-xs text-gray-500">çµŒæ¸ˆå­¦éƒ¨ / ä¸€èˆ¬ä¼šå“¡</p>
                </div>
            </div>
            <div class="space-y-2">
                <button class="w-full flex justify-between items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:bg-gray-50">
                    <span class="flex items-center text-sm font-semibold"><i data-lucide="history" class="w-4 h-4 mr-3 text-primary"></i>åˆ©ç”¨å±¥æ­´</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                </button>
                <button class="w-full flex justify-between items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:bg-gray-50">
                    <span class="flex items-center text-sm font-semibold"><i data-lucide="settings" class="w-4 h-4 mr-3 text-gray-500"></i>è¨­å®š</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                </button>
            </div>
            <button class="mt-8 w-full py-3 text-red-500 text-sm font-bold border border-red-100 bg-red-50 rounded-xl hover:bg-red-100">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </section>

    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ -->
    <footer id="app-footer" class="bg-white border-t border-gray-200 pb-safe">
        <div class="container mx-auto px-1 py-2 flex justify-between">
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-primary transition-colors" data-screen="screen-home">
                <i data-lucide="map" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">ãƒ›ãƒ¼ãƒ </span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-stamp">
                <i data-lucide="stamp" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">ã‚¹ã‚¿ãƒ³ãƒ—</span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-coupon">
                <i data-lucide="ticket" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">ã‚¯ãƒ¼ãƒãƒ³</span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-news">
                <i data-lucide="bell" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">ãŠçŸ¥ã‚‰ã›</span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-mypage">
                <i data-lucide="user" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
            </button>
        </div>
    </footer>

    <!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->

    <!-- ãŠçŸ¥ã‚‰ã›è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« (äºˆç´„ãƒœã‚¿ãƒ³è¿½åŠ ) -->
    <div id="modal-news-detail" class="modal">
        <div class="modal-content p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span id="news-modal-category" class="text-xs font-bold px-2 py-1 rounded text-white bg-gray-500">APP</span>
                    <span id="news-modal-date" class="text-xs text-gray-400 ml-2">2023/11/25</span>
                </div>
                <button onclick="closeModal('modal-news-detail')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <h3 id="news-modal-title" class="text-lg font-bold text-gray-800 mb-4 leading-tight">ã‚¿ã‚¤ãƒˆãƒ«</h3>
            <img id="news-modal-img" class="w-full h-40 object-cover rounded-lg mb-4 hidden" src="" alt="News Image">
            <div id="news-modal-content" class="text-sm text-gray-600 leading-relaxed space-y-2 mb-6"></div>
            
            <button onclick="goToBookingFromNews()" class="w-full bg-primary text-white font-bold py-3 rounded-lg shadow-md hover:bg-primary-dark transition flex items-center justify-center mb-3">
                <i data-lucide="car" class="w-5 h-5 mr-2"></i>
                ã“ã“ã¸è¡ŒããŸã‚ã«è»Šã‚’äºˆç´„ã™ã‚‹
            </button>
            <button onclick="closeModal('modal-news-detail')" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-lg hover:bg-gray-200">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ãƒ«ãƒ¼ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« (æ–°è¦è¿½åŠ ) -->
    <div id="modal-route-detail" class="modal">
        <div class="modal-content p-0 overflow-hidden">
            <div class="bg-gray-800 h-32 flex items-end p-4 relative">
                <!-- å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã“ã“ã«Google Mapsã®é™çš„ç”»åƒãªã©ã‚’å…¥ã‚Œã‚‹ -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent z-10"></div>
                <img src="https://placehold.co/600x300/333/666?text=Map+View" class="absolute inset-0 w-full h-full object-cover opacity-50">
                <button onclick="closeModal('modal-route-detail')" class="absolute top-4 right-4 bg-black/50 text-white rounded-full p-1 z-20"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="relative z-20 text-white">
                    <h3 id="route-modal-title" class="text-xl font-bold mb-1">ãƒ«ãƒ¼ãƒˆå</h3>
                    <p class="text-xs opacity-80"><i data-lucide="clock" class="w-3 h-3 inline mr-1"></i><span id="route-modal-time">60åˆ†</span></p>
                </div>
            </div>
            <div class="p-5">
                <h4 class="font-bold text-gray-700 mb-3 text-sm">ç«‹ã¡å¯„ã‚Šã‚¹ãƒãƒƒãƒˆ</h4>
                <div class="space-y-4 relative pl-4 border-l-2 border-gray-200 ml-2" id="route-modal-spots">
                    <!-- JSã§ã‚¹ãƒãƒƒãƒˆç”Ÿæˆ -->
                </div>
                
                <div class="mt-6 bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4">
                    <p class="text-xs font-bold text-yellow-700 mb-1">ğŸ é”æˆç‰¹å…¸</p>
                    <p id="route-modal-benefit" class="text-sm text-gray-700">ã‚¯ãƒ¼ãƒãƒ³æƒ…å ±</p>
                </div>

                <button onclick="goToBookingFromNews()" class="w-full bg-primary text-white font-bold py-3 rounded-lg shadow-md hover:bg-primary-dark transition flex items-center justify-center">
                    <i data-lucide="car" class="w-5 h-5 mr-2"></i>
                    ã“ã®ãƒ«ãƒ¼ãƒˆã§è»Šã‚’äºˆç´„ã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- (ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤: å ±é…¬, ã‚¯ãƒ¼ãƒãƒ³, ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼, äºˆç´„ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰, å®Œäº†, è¿”å´) -->
    <div id="modal-rewards" class="modal">
        <div class="modal-content p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i data-lucide="gift" class="mr-2 text-secondary"></i>é”æˆå ±é…¬ã‚«ã‚¿ãƒ­ã‚°</h3>
                <button onclick="closeModal('modal-rewards')" class="text-gray-500 bg-gray-100 rounded-full p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’9å€‹é›†ã‚ã‚‹ã¨ã€ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰<span class="font-bold text-yellow-700">ãŠå¥½ããªæ™¯å“ã‚’1ã¤</span>ãŠé¸ã³ã„ãŸã ã‘ã¾ã™ï¼</p>
            <div class="space-y-3" id="reward-list"></div>
            <div class="mt-6 text-center"><button onclick="closeModal('modal-rewards')" class="w-full bg-gray-200 text-gray-600 font-bold py-3 rounded-xl">é–‰ã˜ã‚‹</button></div>
        </div>
    </div>

    <div id="modal-use-coupon" class="modal">
        <div class="modal-content p-6 text-center">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</h2>
            <div class="bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200"><p id="modal-coupon-title" class="font-bold text-lg text-yellow-700 mb-1">ã‚¯ãƒ¼ãƒãƒ³å</p><p class="text-sm text-yellow-600">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</p></div>
            <div class="flex space-x-3"><button onclick="closeModal('modal-use-coupon')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button id="btn-confirm-use-coupon" class="flex-1 bg-primary text-white font-bold py-3 rounded-lg shadow">ä½¿ç”¨ã™ã‚‹</button></div>
        </div>
    </div>

    <div id="modal-calendar" class="modal">
        <div class="modal-content p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">æœˆé–“äºˆç´„çŠ¶æ³</h3>
                <button onclick="closeModal('modal-calendar')" class="text-gray-500 bg-gray-100 rounded-full p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">ç¢ºèªã™ã‚‹è»Šä¸¡</label>
                <select id="calendar-car-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white font-bold" onchange="renderCalendar()"></select>
            </div>
            <div class="mb-2 text-center font-bold text-lg" id="calendar-month-label"></div>
            <div class="grid grid-cols-7 gap-1 mb-1 text-center text-xs text-gray-500 font-bold">
                <div class="text-red-500">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div class="text-blue-500">åœŸ</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            <div class="flex justify-center gap-4 mt-4 text-xs text-gray-500"><span class="flex items-center"><span class="status-ok mr-1">â—</span>ä½™è£•ã‚ã‚Š</span><span class="flex items-center"><span class="status-few mr-1">â–³</span>æ®‹ã‚Šã‚ãšã‹</span><span class="flex items-center"><span class="status-full mr-1">Ã—</span>æº€è»Š</span></div>
        </div>
    </div>

    <div id="modal-booking-wizard" class="modal">
        <div class="modal-content">
            <div class="relative h-32 bg-gray-200">
                <img id="wizard-car-img" src="" alt="Vehicle" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                <button class="close-modal absolute top-4 right-4 bg-black/50 text-white rounded-full p-1.5 backdrop-blur-sm z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="absolute bottom-3 left-4 text-white"><h2 id="wizard-car-name" class="text-xl font-bold leading-tight">Car Name</h2></div>
            </div>
            <div class="p-5">
                <div class="flex items-center justify-between mb-6 px-2">
                    <div class="flex flex-col items-center"><div id="step-dot-1" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm">1</div><span class="text-[10px] mt-1 text-gray-500 font-bold">æ–™é‡‘</span></div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-2"></div>
                    <div class="flex flex-col items-center"><div id="step-dot-2" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm">2</div><span class="text-[10px] mt-1 text-gray-500 font-bold">æ—¥æ™‚</span></div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-2"></div>
                    <div class="flex flex-col items-center"><div id="step-dot-3" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm">3</div><span class="text-[10px] mt-1 text-gray-500 font-bold">å®Œäº†</span></div>
                </div>
                <div id="step-content-1">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ãƒ—ãƒ©ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
                    <div class="space-y-3 mb-6">
                        <label class="relative flex items-center justify-between p-4 border-2 border-gray-200 bg-white rounded-xl cursor-pointer hover:border-primary hover:bg-blue-50 transition shadow-sm group">
                            <div class="flex items-center"><input type="radio" name="plan" value="0" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary cursor-pointer"><div class="ml-3"><span class="block text-base font-bold text-gray-800">çŸ­æ™‚é–“åˆ©ç”¨</span><span class="block text-xs text-gray-500 group-hover:text-gray-700">10åˆ†å˜ä½ã§åˆ©ç”¨å¯èƒ½</span></div></div><span class="text-xl font-bold text-primary">50å††<span class="text-xs text-gray-500">/10åˆ†</span></span>
                        </label>
                        <label class="relative flex items-center justify-between p-4 border-2 border-primary bg-blue-50 rounded-xl cursor-pointer hover:bg-blue-100 transition shadow-sm group">
                            <div class="flex items-center"><input type="radio" name="plan" value="2" checked class="w-5 h-5 text-primary border-gray-300 focus:ring-primary cursor-pointer"><div class="ml-3"><span class="block text-base font-bold text-gray-800">2æ™‚é–“ãƒ‘ãƒƒã‚¯</span><span class="block text-xs text-gray-500 group-hover:text-gray-700">ã¡ã‚‡ã„ä¹—ã‚Šã«æœ€é©</span></div></div><span class="text-xl font-bold text-primary">500å††</span>
                        </label>
                        <label class="relative flex items-center justify-between p-4 border-2 border-gray-200 bg-white rounded-xl cursor-pointer hover:border-primary hover:bg-blue-50 transition shadow-sm group">
                            <div class="flex items-center"><input type="radio" name="plan" value="24" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary cursor-pointer"><div class="ml-3"><span class="block text-base font-bold text-gray-800">çµ‚æ—¥ãƒ‘ãƒƒã‚¯</span><span class="block text-xs text-gray-500 group-hover:text-gray-700">1æ—¥ã‚†ã£ãã‚Šåˆ©ç”¨</span></div></div><span class="text-xl font-bold text-primary">1,000å††</span>
                        </label>
                    </div>
                    <button onclick="goToStep(2)" class="w-full bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-primary-dark transition flex items-center justify-center">æ¬¡ã¸é€²ã‚€</button>
                </div>
                <div id="step-content-2" class="hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">ã„ã¤åˆ©ç”¨ã—ã¾ã™ã‹ï¼Ÿ</h3>
                    <div class="mb-4">
                        <div class="flex justify-between items-end mb-1"><span class="text-xs font-bold text-gray-500">æœ¬æ—¥ã®äºˆç´„çŠ¶æ³ (0:00 - 24:00)</span><div class="flex items-center text-[10px] space-x-2"><span class="flex items-center"><span class="w-2 h-2 bg-red-500 rounded-sm mr-1"></span>äºˆç´„æ¸ˆ</span><span class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-sm mr-1"></span>é¸æŠä¸­</span></div></div>
                        <div id="schedule-bar-container" class="schedule-bar border border-gray-300"></div>
                        <div class="relative h-4 w-full mt-1"><span class="schedule-label" style="left: 0%">0æ™‚</span><span class="schedule-label" style="left: 25%">6æ™‚</span><span class="schedule-label" style="left: 50%">12æ™‚</span><span class="schedule-label" style="left: 75%">18æ™‚</span><span class="schedule-label" style="left: 100%">24æ™‚</span></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button id="btn-now" class="border-2 border-secondary bg-orange-50 p-3 rounded-lg text-center hover:bg-orange-100 transition active:scale-95"><i data-lucide="zap" class="w-6 h-6 text-secondary mx-auto mb-1"></i><span class="block text-sm font-bold text-secondary">ä»Šã™ãå€Ÿã‚Šã‚‹</span></button>
                        <button id="btn-later" class="border-2 border-gray-200 bg-white p-3 rounded-lg text-center hover:bg-gray-50 transition active:scale-95"><i data-lucide="calendar-clock" class="w-6 h-6 text-gray-400 mx-auto mb-1"></i><span class="block text-sm font-bold text-gray-600">æ—¥æ™‚ã‚’æŒ‡å®š</span></button>
                    </div>
                    <div id="custom-time-input" class="hidden mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200"><label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ—¥æ™‚</label><input type="datetime-local" id="input-start-time" class="w-full p-2 border border-gray-300 rounded-lg text-sm"></div>
                    <div class="bg-blue-50 p-3 rounded-lg mb-6"><div class="flex justify-between text-sm mb-1"><span class="text-gray-500">åˆ©ç”¨é–‹å§‹</span><span id="wizard-start-time" class="font-bold">--:--</span></div><div class="flex justify-between text-sm"><span class="text-gray-500">åˆ©ç”¨çµ‚äº†(äºˆå®š)</span><span id="wizard-end-time" class="font-bold">--:--</span></div></div>
                    <div class="flex space-x-3"><button onclick="goToStep(1)" class="w-1/3 bg-gray-200 text-gray-600 font-bold py-3.5 rounded-xl hover:bg-gray-300 transition">æˆ»ã‚‹</button><button onclick="confirmBooking()" class="w-2/3 bg-secondary text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-orange-600 transition">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-success" class="modal">
        <div class="modal-content p-8 text-center rounded-xl">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><i data-lucide="check" class="w-10 h-10 text-green-600"></i></div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">äºˆç´„å®Œäº†ï¼</h2>
            <p class="text-sm text-gray-500 mb-8">äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸã€‚<br>åˆ©ç”¨é–‹å§‹æ™‚é–“ã«ãªã‚Šã¾ã—ãŸã‚‰è§£éŒ ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-8 relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-secondary"></div><p class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">Unlock Code</p><p class="text-4xl font-mono font-bold text-gray-800 tracking-[0.2em] ml-2">8931</p></div>
            <button onclick="finishBookingProcess()" class="w-full bg-gray-800 text-white font-bold py-3.5 rounded-xl hover:bg-gray-900 transition">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="modal-return" class="modal">
        <div class="modal-content p-6 text-center">
            <h2 class="text-xl font-bold mb-4">è¿”å´æ‰‹ç¶šã</h2>
            <p class="text-gray-600 mb-6 text-sm">å…ƒã®å ´æ‰€ï¼ˆæ»å­ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ï¼‰ã«é§è»Šã—ã¾ã—ãŸã‹ï¼Ÿ<br>è»Šå†…ã®å¿˜ã‚Œç‰©ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
            <div class="flex space-x-3"><button onclick="closeModal('modal-return')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onclick="completeReturn()" class="flex-1 bg-primary text-white font-bold py-3 rounded-lg shadow">è¿”å´ã™ã‚‹</button></div>
        </div>
    </div>

    <div id="modal-return-success" class="modal">
        <div class="modal-content p-8 text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="thumbs-up" class="w-8 h-8 text-primary"></i></div>
            <h2 class="text-xl font-bold mb-2">è¿”å´å®Œäº†ï¼</h2>
            <p class="text-sm text-gray-500 mb-4">ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>ã¾ãŸã®ã”åˆ©ç”¨ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚</p>
            <p class="text-xs text-gray-400">â€» æ–™é‡‘ã¯ç™»éŒ²ã‚«ãƒ¼ãƒ‰ã‹ã‚‰æ±ºæ¸ˆã•ã‚Œã¾ã™</p>
            <button onclick="closeModal('modal-return-success')" class="mt-6 w-full bg-gray-800 text-white font-bold py-3 rounded-lg">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© ---

        // ãŠçŸ¥ã‚‰ã›ãƒ‡ãƒ¼ã‚¿ (æ›´æ–°)
        const NEWS_DATA = [
            { id: 1, date: '2023/11/25', category: 'app', title: 'ã‚¢ãƒ—ãƒªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãŠçŸ¥ã‚‰ã› (Ver14.0)', content: 'ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ã—ã€ãŠã™ã™ã‚æƒ…å ±ã‚„ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ãŒè¦‹ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚', image: '' },
            { id: 2, date: '2023/11/20', category: 'event', title: 'ã€çŠ¬å±±è¦³å…‰å”ä¼šã€‘ç§‹ã®åŸä¸‹ç”ºã¾ã¤ã‚Šé–‹å‚¬ä¸­ï¼', content: 'çŠ¬å±±åŸä¸‹ç”ºã«ã¦ç§‹ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒé–‹å‚¬ä¸­ã§ã™ã€‚\nãœã²ãƒ‰ãƒ©ã‚¤ãƒ–ã§ãŠå‡ºã‹ã‘ãã ã•ã„ï¼', image: 'https://placehold.co/400x200/F5A623/FFFFFF?text=Inuyama+Festival' },
            { id: 3, date: '2023/11/18', category: 'coupon', title: 'ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼æ™¯å“ãŒãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼', content: 'é”æˆå ±é…¬ãŒã‚ˆã‚Šè±ªè¯ã«ãªã‚Šã¾ã—ãŸã€‚', image: '' },
            { id: 4, date: '2023/11/15', category: 'event', title: 'ã€è’²éƒ¡ã€‘ãƒ©ã‚°ãƒ¼ãƒŠãƒ»ã‚¤ãƒ«ãƒŸãƒãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹', content: 'å†¬ã®ãƒ©ã‚°ãƒ¼ãƒŠãƒ†ãƒ³ãƒœã‚¹ã¯ã‚¤ãƒ«ãƒŸãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒç¶ºéº—ã§ã™ã€‚', image: 'https://placehold.co/400x200/00A7C7/FFFFFF?text=Laguna+Illumi' }
        ];

        // ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
        const ROUTES = [
            { id: 1, name: "ã€åŒ—ã¸ã€‘çŠ¬å±±ãƒ»åŸä¸‹ç”ºãƒ«ãƒ¼ãƒˆ", time: "ç‰‡é“ç´„50åˆ†", benefit: "é£Ÿã¹æ­©ãã‚¯ãƒ¼ãƒãƒ³", spots: ["çŠ¬å±±åŸ", "åŸä¸‹ç”º"] },
            { id: 2, name: "ã€æ±ã¸ã€‘è’²éƒ¡ãƒ»ãƒ©ã‚°ãƒ¼ãƒŠãƒ«ãƒ¼ãƒˆ", time: "ç‰‡é“ç´„60åˆ†", benefit: "å…¥é¤¨æ–™å‰²å¼•", spots: ["ãƒ©ã‚°ãƒ¼ãƒŠãƒ†ãƒ³ãƒœã‚¹", "ç«¹å³¶æ°´æ—é¤¨"] },
            { id: 3, name: "ã€å—ã¸ã€‘å—çŸ¥å¤šãƒ»ç¾æµœãƒ«ãƒ¼ãƒˆ", time: "ç‰‡é“ç´„50åˆ†", benefit: "ç‰¹ç”£å“ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", spots: ["å—çŸ¥å¤šãƒ“ãƒ¼ãƒãƒ©ãƒ³ãƒ‰", "é­šå¤ªéƒ"] }
        ];

        // ... (ä»¥ä¸‹ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å®šç¾©: STAMP_DATA, REWARD_DATA, COUPON_DATA, CAR_DATA, SPONSOR_DATA, state) ...
        const STAMP_DATA = [
            { id: 1, earned: true, date: '11/02' }, { id: 2, earned: true, date: '11/15' }, { id: 3, earned: false, date: null },
            { id: 4, earned: false, date: null }, { id: 5, earned: false, date: null }, { id: 6, earned: false, date: null },
            { id: 7, earned: false, date: null }, { id: 8, earned: false, date: null }, { id: 9, earned: false, date: null }
        ];
        const REWARD_DATA = [
            { id: 1, name: "ç”Ÿå”åˆ©ç”¨åˆ¸ 500å††åˆ†", icon: "shopping-basket", desc: "å­¦å†…ã®ç”Ÿå”é£Ÿå ‚ãƒ»å£²åº—ã§åˆ©ç”¨å¯èƒ½" },
            { id: 2, name: "2æ™‚é–“ãƒ‘ãƒƒã‚¯ç„¡æ–™åˆ¸ Ã— 2æš", icon: "clock", desc: "ã¡ã‚‡ã£ã¨ã—ãŸãŠå‡ºã‹ã‘ã«ä¾¿åˆ©ï¼ˆ2å›åˆ†ï¼‰" },
            { id: 3, name: "çµ‚æ—¥ãƒ‘ãƒƒã‚¯ç„¡æ–™åˆ¸", icon: "calendar-check", desc: "1æ—¥ä¸­è‡ªç”±ã«ä½¿ãˆã‚‹æœ€å¼·ãƒã‚±ãƒƒãƒˆ" }
        ];
        const COUPON_DATA = [
            { id: 1, title: "åˆå›åˆ©ç”¨å‰²å¼•", discount: "500å††OFF", desc: "åˆå›åˆ©ç”¨é™å®š", expire: "2025/12/31", status: "active" },
            { id: 2, title: "çŠ¬å±±é£Ÿã¹æ­©ã", discount: "ã‚¯ãƒ¼ãƒãƒ³åˆ¸", desc: "çŠ¬å±±åŸä¸‹ç”ºå¯¾è±¡åº—èˆ—", expire: "2025/03/31", status: "active" },
            { id: 3, title: "èª•ç”Ÿæ—¥ã‚¯ãƒ¼ãƒãƒ³", discount: "20%OFF", desc: "ãŠèª•ç”Ÿæ—¥æœˆé™å®š", expire: "2025/01/31", status: "active" },
            { id: 4, title: "é•·æ™‚é–“ãƒ‘ãƒƒã‚¯å‰²", discount: "10%OFF", desc: "6æ™‚é–“ä»¥ä¸Šã®ã”åˆ©ç”¨ã§é©ç”¨", expire: "2024/11/01", status: "used" }
        ];
        const CAR_DATA = [
            { id: 1, name: "ãƒ€ã‚¤ãƒãƒ„ ãƒŸãƒ©ã‚¤ãƒ¼ã‚¹ (A)", location: "æ»å­ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ»æ±é§è¼ªå ´æ¨ª", image: "https://placehold.co/400x250/00A7C7/FFFFFF?text=MIRA+A", status: "available", capacity: 4, schedule: [[10, 13]] },
            { id: 2, name: "ãƒ€ã‚¤ãƒãƒ„ ãƒŸãƒ©ã‚¤ãƒ¼ã‚¹ (B)", location: "æ»å­ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ»æ­£é–€ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼", image: "https://placehold.co/400x250/0089A1/FFFFFF?text=MIRA+B", status: "available", capacity: 4, schedule: [] },
            { id: 3, name: "ãƒˆãƒ¨ã‚¿ ã‚¢ã‚¯ã‚¢", location: "æ»å­ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ»æ±é§è¼ªå ´æ¨ª", image: "https://placehold.co/400x250/F5A623/FFFFFF?text=AQUA", status: "booked", capacity: 5, schedule: [[0, 24]] },
            { id: 4, name: "ãƒˆãƒ¨ã‚¿ ãƒ´ã‚©ã‚¯ã‚·ãƒ¼", location: "æ»å­ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ»éƒ¨å®¤æ£Ÿä»˜è¿‘", image: "https://placehold.co/400x250/006A5C/FFFFFF?text=VOXY", status: "available", capacity: 8, schedule: [[14, 18], [20, 22]] }
        ];
        const SPONSOR_DATA = [
            { name: "åå¸‚å¤§ æ»å­ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ (å‡ºç™ºåœ°)", lat: 35.1385, lng: 136.9325, type: "campus" },
            { name: "ç†±ç”°ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«", lat: 35.1332, lng: 136.9056, type: "spot" },
            { name: "ã‚³ãƒ¡ãƒ€çˆç²åº— (æ¡œå±±åº—)", lat: 35.1415, lng: 136.9335, type: "cafe" },
            { name: "ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¯ãƒ³ (åƒç¨®åº—)", lat: 35.1675, lng: 136.9230, type: "leisure" },
            { name: "ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¯ãƒ³ (ä¸­å·1å·ç·šåº—)", lat: 35.1270, lng: 136.8655, type: "leisure" },
            { name: "å¤§é ˆãƒ»æ „ã‚¨ãƒªã‚¢ (é£²é£Ÿãƒ»ã‚«ãƒ•ã‚§)", lat: 35.1598, lng: 136.9000, type: "spot" },
            { name: "çŠ¬å±±è¦³å…‰å”ä¼š (çŠ¬å±±åŸ)", lat: 35.3886, lng: 136.9392, type: "tourism" },
            { name: "è’²éƒ¡å¸‚è¦³å…‰å”ä¼š (ãƒ©ã‚°ãƒ¼ãƒŠ)", lat: 34.8085, lng: 137.2724, type: "tourism" },
            { name: "çŸ¥å¤šåŠå³¶è¦³å…‰å”ä¼š (å—çŸ¥å¤š)", lat: 34.7175, lng: 136.9450, type: "tourism" }
        ];
        let state = { selectedCar: null, startTime: new Date(), planHours: 2, activeBooking: null, currentMonth: new Date(), selectedCoupon: null };

        // --- 2. åˆæœŸåŒ– ---
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            initMap();
            renderCars();
            renderCoupons();
            renderRewards();
            setupNavigation();
            setupInteractions();
            renderStamps();
            renderWeeklySchedule(); 
            renderHomeNews(); 
            renderNews(); 
            renderRoutes(); // ãƒ«ãƒ¼ãƒˆãƒªã‚¹ãƒˆæç”»
            
            const now = new Date();
            now.setMinutes(Math.ceil(now.getMinutes() / 30) * 30, 0, 0); 
            document.getElementById('input-start-time').value = toLocalISOString(now);
        });

        // ... (å…±é€šé–¢æ•°: toLocalISOString, initMap ãªã©ã¯å¤‰æ›´ãªã—) ...
        function toLocalISOString(date) { const pad = (num) => (num < 10 ? '0' : '') + num; return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) + 'T' + pad(date.getHours()) + ':' + pad(date.getMinutes()); }
        
        let map;
        function initMap() {
            map = L.map('map-container').setView([35.1385, 136.9325], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            SPONSOR_DATA.forEach(spot => {
                let color = '#00A7C7';
                if(spot.type === 'campus') color = '#006A5C'; if(spot.type === 'tourism') color = '#F5A623'; if(spot.type === 'leisure') color = '#E11D48';
                const customIcon = L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:${color}; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
                L.marker([spot.lat, spot.lng], {icon: customIcon}).addTo(map).bindPopup(`<b>${spot.name}</b>`);
            });
        }

        // --- ãƒ«ãƒ¼ãƒˆè©³ç´°æ©Ÿèƒ½ (æ–°è¦) ---
        function renderRoutes() {
            const container = document.getElementById('route-list');
            if(!container) return;
            container.innerHTML = '';
            ROUTES.forEach(route => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start hover:shadow-md transition cursor-pointer';
                el.onclick = () => openRouteModal(route);
                el.innerHTML = `
                    <div class="bg-blue-50 p-2 rounded-lg mr-3 flex-shrink-0"><i data-lucide="map" class="w-6 h-6 text-primary"></i></div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-gray-800">${route.name}</h4>
                        <div class="text-xs text-gray-500 mt-1 space-y-0.5"><p>${route.time} / ${route.spots.join(', ')}</p></div>
                        <p class="text-xs text-secondary mt-2 font-bold border-t border-dashed border-gray-200 pt-1">ç‰¹å…¸: ${route.benefit}</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 mt-2"></i>
                `;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        function openRouteModal(route) {
            const modal = document.getElementById('modal-route-detail');
            document.getElementById('route-modal-title').innerText = route.name;
            document.getElementById('route-modal-time').innerText = route.time;
            document.getElementById('route-modal-benefit').innerText = route.benefit;
            
            const spotsContainer = document.getElementById('route-modal-spots');
            spotsContainer.innerHTML = '';
            route.spots.forEach((spot, idx) => {
                const el = document.createElement('div');
                el.className = 'relative';
                el.innerHTML = `<span class="absolute -left-6 top-0.5 w-4 h-4 rounded-full bg-primary text-white text-[10px] flex items-center justify-center font-bold">${idx+1}</span><p class="text-sm font-bold text-gray-800">${spot}</p>`;
                spotsContainer.appendChild(el);
            });
            
            modal.classList.add('active');
        }

        // äºˆç´„ç”»é¢ã¸ã®é·ç§» (ãŠçŸ¥ã‚‰ã›ãƒ»ãƒ«ãƒ¼ãƒˆã‹ã‚‰)
        window.goToBookingFromNews = function() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            document.querySelector('[data-screen=screen-home]').click();
            setTimeout(() => {
                // è‡ªå‹•çš„ã«ä¸€ç•ªç©ºã„ã¦ã„ã‚‹è»Šï¼ˆä¾‹: ãƒŸãƒ©ã‚¤ãƒ¼ã‚¹Aï¼‰ã®äºˆç´„ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’é–‹ãæ¼”å‡º
                // å®Ÿéš›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸ã°ã›ã‚‹ã¹ãã ãŒã€ãƒ‡ãƒ¢ã¨ã—ã¦
                const targetCar = CAR_DATA.find(c => c.status === 'available');
                if(targetCar) openWizard(targetCar);
            }, 500);
        }

        // ... (æ—¢å­˜é–¢æ•°: renderCoupons, renderCars, renderWeeklySchedule, openWizard, setupInteractions ãªã©ã¯ãã®ã¾ã¾æµç”¨) ...
        
        function renderCoupons() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const activeContainer = document.getElementById('active-coupons'); const usedContainer = document.getElementById('used-coupons'); activeContainer.innerHTML = ''; usedContainer.innerHTML = ''; COUPON_DATA.forEach(coupon => { const isActive = coupon.status === 'active'; const el = document.createElement('div'); el.className = `coupon-ticket bg-white flex rounded-lg overflow-hidden border border-gray-100 shadow-sm min-h-[100px]`; el.innerHTML = `<div class="w-1/3 bg-gray-50 flex flex-col items-center justify-center p-2 border-r border-dashed border-gray-300 relative"><span class="text-xl font-bold text-ncu-green text-center leading-tight">${coupon.discount}</span></div><div class="w-2/3 p-3 flex flex-col justify-between"><div><h4 class="font-bold text-gray-800">${coupon.title}</h4><p class="text-xs text-gray-500">${coupon.desc}</p></div><div class="flex justify-between items-end mt-2"><span class="text-[10px] text-gray-400">æœ‰åŠ¹æœŸé™: ${coupon.expire}</span>${isActive ? `<button onclick="confirmUseCoupon(${coupon.id})" class="text-xs bg-secondary text-white font-bold px-3 py-1.5 rounded-full shadow hover:bg-opacity-90 transition">ä½¿ã†</button>` : `<span class="text-xs bg-gray-200 text-gray-500 font-bold px-3 py-1 rounded-full">ä½¿ç”¨æ¸ˆ</span>`}</div></div>`; if(isActive) activeContainer.appendChild(el); else usedContainer.appendChild(el); }); }
        window.confirmUseCoupon = function(id) { const coupon = COUPON_DATA.find(c => c.id === id); state.selectedCoupon = coupon; document.getElementById('modal-coupon-title').innerText = coupon.title; document.getElementById('modal-use-coupon').classList.add('active'); }
        
        function renderCars() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const container = document.getElementById('car-list-container'); container.innerHTML = ''; CAR_DATA.forEach(car => { const isAvailable = car.status === 'available'; const card = document.createElement('div'); card.className = `bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row gap-4 transition ${!isAvailable ? 'opacity-60 bg-gray-50' : 'hover:shadow-md'}`; let buttonHtml = isAvailable ? `<button class="open-modal-btn w-full mt-2 sm:mt-0 bg-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-primary-dark transition shadow-sm flex items-center justify-center">å€Ÿã‚Šã‚‹</button>` : `<button disabled class="w-full mt-2 sm:mt-0 bg-gray-300 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">äºˆç´„æ¸ˆã¿</button>`; const statusBadge = isAvailable ? `<span class="inline-flex items-center text-ncu-green font-bold text-sm bg-green-50 px-2 py-0.5 rounded"><i data-lucide="check-circle-2" class="w-4 h-4 mr-1"></i>è²¸å‡ºå¯èƒ½</span>` : `<span class="inline-flex items-center text-red-500 font-bold text-sm bg-red-50 px-2 py-0.5 rounded"><i data-lucide="x-circle" class="w-4 h-4 mr-1"></i>è²¸å‡ºä¸å¯</span>`; card.innerHTML = `<div class="relative w-full sm:w-32 h-32 sm:h-24 flex-shrink-0"><img src="${car.image}" class="w-full h-full object-cover rounded-lg bg-gray-200">${!isAvailable ? '<div class="absolute inset-0 bg-black/10 rounded-lg flex items-center justify-center"><span class="bg-black/60 text-white text-xs px-2 py-1 rounded">åˆ©ç”¨ä¸­</span></div>' : ''}</div><div class="flex-grow flex flex-col justify-between"><div><div class="flex justify-between items-start"><h4 class="font-bold text-lg text-gray-800 leading-tight">${car.name}</h4></div><div class="mt-2">${statusBadge}</div></div><div class="mt-3 flex items-center justify-between"><span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${car.capacity}äººä¹—ã‚Š</span>${buttonHtml}</div></div>`; if (isAvailable) { const btn = card.querySelector('.open-modal-btn'); btn.onclick = () => openWizard(car); } container.appendChild(card); }); lucide.createIcons(); }

        function renderWeeklySchedule() { /* ãƒ‡ã‚¶ã‚¤ãƒ³å¾®ä¿®æ­£ */ const headerRow = document.getElementById('weekly-header-row'); const bodyRows = document.getElementById('weekly-body-rows'); let headerHtml = '<th class="pb-2 text-left pl-2 font-normal text-xs w-24 sticky left-0 bg-white shadow-sm z-10">è»Šä¸¡</th>'; const today = new Date(); const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ']; for(let i=0; i<7; i++) { const d = new Date(today); d.setDate(today.getDate() + i); const dayStr = `${d.getMonth()+1}/${d.getDate()}`; const weekStr = days[d.getDay()]; const colorClass = d.getDay() === 0 ? 'text-red-500' : (d.getDay() === 6 ? 'text-blue-500' : ''); headerHtml += `<th class="pb-2 font-normal text-xs min-w-[40px] ${colorClass}">${dayStr}<br>(${weekStr})</th>`; } headerRow.innerHTML = headerHtml; let bodyHtml = ''; CAR_DATA.forEach((car) => { let rowHtml = `<tr class="border-b border-gray-50 last:border-0 h-10">`; rowHtml += `<td class="text-left pl-2 text-xs font-bold sticky left-0 bg-white shadow-sm z-10 truncate max-w-[90px]">${car.name.replace('ãƒ€ã‚¤ãƒãƒ„ ','').replace('ãƒˆãƒ¨ã‚¿ ','')}</td>`; for(let i=0; i<7; i++) { const isWeekend = (new Date().getDay() + i) % 7 === 0 || (new Date().getDay() + i) % 7 === 6; const status = getRandomStatus(!isWeekend); let cellClass = ''; if(status === 'ok') cellClass = 'status-ok-cell'; else if(status === 'full') cellClass = 'status-full-cell'; rowHtml += `<td class="${cellClass}">${getStatusHtml(status)}</td>`; } rowHtml += `</tr>`; bodyHtml += rowHtml; }); bodyRows.innerHTML = bodyHtml; }
        function getRandomStatus(biasToEmpty = true) { const r = Math.random(); if (biasToEmpty) { if(r > 0.8) return 'full'; if(r > 0.6) return 'few'; return 'ok'; } else { if(r > 0.5) return 'full'; if(r > 0.2) return 'few'; return 'ok'; } }
        function getStatusHtml(status) { if(status === 'ok') return 'â—'; if(status === 'few') return 'â–³'; return 'Ã—'; }

        function openMonthlyCalendar() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const select = document.getElementById('calendar-car-select'); select.innerHTML = ''; CAR_DATA.forEach(car => { const opt = document.createElement('option'); opt.value = car.id; opt.innerText = car.name; select.appendChild(opt); }); renderCalendar(); document.getElementById('modal-calendar').classList.add('active'); }
        function renderCalendar() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const grid = document.getElementById('calendar-grid'); grid.innerHTML = ''; const now = state.currentMonth; document.getElementById('calendar-month-label').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ`; const firstDay = new Date(now.getFullYear(), now.getMonth(), 1); const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0); for(let i=0; i<firstDay.getDay(); i++) { const empty = document.createElement('div'); grid.appendChild(empty); } const today = new Date(); for(let d=1; d<=lastDay.getDate(); d++) { const cellDate = new Date(now.getFullYear(), now.getMonth(), d); const isToday = cellDate.getDate() === today.getDate() && cellDate.getMonth() === today.getMonth(); const isWeekend = cellDate.getDay() === 0 || cellDate.getDay() === 6; const status = getRandomStatus(!isWeekend); const cell = document.createElement('div'); cell.className = `calendar-cell bg-gray-50 ${isToday ? 'today' : ''}`; cell.innerHTML = `<span class="${cellDate.getDay()===0?'text-red-500':(cellDate.getDay()===6?'text-blue-500':'text-gray-700')}">${d}</span><div class="status-mark ${status === 'ok' ? 'status-ok' : (status === 'full' ? 'status-full' : 'status-few')}">${getStatusHtml(status)}</div>`; grid.appendChild(cell); } }

        function openWizard(car) { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ state.selectedCar = car; const modal = document.getElementById('modal-booking-wizard'); document.getElementById('wizard-car-img').src = car.image; document.getElementById('wizard-car-name').innerText = car.name; goToStep(1); const radios = document.getElementsByName('plan'); radios.forEach(r => { if(r.value == "2") r.checked = true; r.onchange = () => { updatePlanStyle(); renderScheduleBar(); updateWizardTimeDisplay(); }; }); updatePlanStyle(); selectTimeMode('now'); modal.classList.add('active'); }
        function goToStep(step) { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById('step-content-1').classList.add('hidden'); document.getElementById('step-content-2').classList.add('hidden'); document.getElementById(`step-content-${step}`).classList.remove('hidden'); const setDot = (id, active) => { const el = document.getElementById(id); if(active) { el.classList.add('bg-primary', 'text-white'); el.classList.remove('bg-gray-200', 'text-gray-500'); } else { el.classList.remove('bg-primary', 'text-white'); el.classList.add('bg-gray-200', 'text-gray-500'); } }; if(step === 1) { setDot('step-dot-1', true); setDot('step-dot-2', false); setDot('step-dot-3', false); } else if(step === 2) { setDot('step-dot-1', true); setDot('step-dot-2', true); setDot('step-dot-3', false); renderScheduleBar(); updateWizardTimeDisplay(); } }
        function updatePlanStyle() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const radios = document.getElementsByName('plan'); radios.forEach(radio => { const label = radio.closest('label'); if (radio.checked) { label.classList.add('border-primary', 'bg-blue-50'); label.classList.remove('border-gray-200', 'bg-white'); state.planHours = parseInt(radio.value); } else { label.classList.remove('border-primary', 'bg-blue-50'); label.classList.add('border-gray-200', 'bg-white'); } }); }
        function setupInteractions() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById('btn-now').addEventListener('click', () => { selectTimeMode('now'); }); document.getElementById('btn-later').addEventListener('click', () => { selectTimeMode('later'); }); document.getElementById('input-start-time').addEventListener('change', () => { state.startTime = new Date(document.getElementById('input-start-time').value); renderScheduleBar(); updateWizardTimeDisplay(); }); document.querySelectorAll('.close-modal').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }); }); document.querySelectorAll('.coupon-tab').forEach(btn => { btn.addEventListener('click', function() { const target = this.dataset.target; document.getElementById('active-coupons').classList.add('hidden'); document.getElementById('used-coupons').classList.add('hidden'); document.getElementById(target).classList.remove('hidden'); document.querySelectorAll('.coupon-tab').forEach(t => { t.classList.remove('bg-white', 'shadow', 'text-primary'); t.classList.add('text-gray-500'); }); this.classList.add('bg-white', 'shadow', 'text-primary'); this.classList.remove('text-gray-500'); }); }); document.getElementById('btn-confirm-use-coupon').addEventListener('click', () => { if(state.selectedCoupon) { state.selectedCoupon.status = 'used'; renderCoupons(); closeModal('modal-use-coupon'); } }); document.querySelectorAll('.news-tab').forEach(btn => { btn.addEventListener('click', function() { const filter = this.dataset.filter; renderNews(filter); document.querySelectorAll('.news-tab').forEach(t => { t.classList.remove('bg-ncu-green', 'text-white'); t.classList.add('bg-gray-100', 'text-gray-500'); }); this.classList.remove('bg-gray-100', 'text-gray-500'); this.classList.add('bg-ncu-green', 'text-white'); }); }); }
        function selectTimeMode(mode) { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const btnNow = document.getElementById('btn-now'); const btnLater = document.getElementById('btn-later'); const inputArea = document.getElementById('custom-time-input'); if(mode === 'now') { btnNow.classList.add('border-secondary', 'bg-orange-50'); btnNow.classList.remove('border-gray-200', 'bg-white'); btnNow.querySelector('span').classList.add('text-secondary'); btnLater.classList.remove('border-secondary', 'bg-orange-50'); btnLater.classList.add('border-gray-200', 'bg-white'); btnLater.querySelector('span').classList.remove('text-secondary'); inputArea.classList.add('hidden'); const now = new Date(); now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15, 0, 0); state.startTime = now; } else { btnLater.classList.add('border-secondary', 'bg-orange-50'); btnLater.classList.remove('border-gray-200', 'bg-white'); btnLater.querySelector('span').classList.add('text-secondary'); btnNow.classList.remove('border-secondary', 'bg-orange-50'); btnNow.classList.add('border-gray-200', 'bg-white'); btnNow.querySelector('span').classList.remove('text-secondary'); inputArea.classList.remove('hidden'); const val = document.getElementById('input-start-time').value; if(val) state.startTime = new Date(val); } renderScheduleBar(); updateWizardTimeDisplay(); }
        function renderScheduleBar() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const container = document.getElementById('schedule-bar-container'); container.innerHTML = ''; const totalMinutes = 24 * 60; state.selectedCar.schedule.forEach(range => { const startMin = range[0] * 60; const endMin = range[1] * 60; const width = ((endMin - startMin) / totalMinutes) * 100; const left = (startMin / totalMinutes) * 100; const el = document.createElement('div'); el.className = 'schedule-segment booked absolute top-0 bottom-0'; el.style.left = `${left}%`; el.style.width = `${width}%`; container.appendChild(el); }); const startH = state.startTime.getHours(); const startM = state.startTime.getMinutes(); const startTotalM = startH * 60 + startM; const endTotalM = startTotalM + (state.planHours * 60); const displayStart = Math.max(0, startTotalM); const displayEnd = Math.min(totalMinutes, endTotalM); if(displayEnd > displayStart) { const width = ((displayEnd - displayStart) / totalMinutes) * 100; const left = (displayStart / totalMinutes) * 100; const el = document.createElement('div'); el.className = 'schedule-segment selected absolute top-0 bottom-0'; el.style.left = `${left}%`; el.style.width = `${width}%`; container.appendChild(el); } }
        function updateWizardTimeDisplay() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const formatTime = (date) => `${date.getHours()}:${(date.getMinutes()<10?'0':'') + date.getMinutes()}`; const endDate = new Date(state.startTime.getTime() + state.planHours * 60 * 60 * 1000); document.getElementById('wizard-start-time').innerText = formatTime(state.startTime); document.getElementById('wizard-end-time').innerText = formatTime(endDate); }
        function confirmBooking() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById('modal-booking-wizard').classList.remove('active'); setTimeout(() => { document.getElementById('modal-success').classList.add('active'); }, 300); }
        function finishBookingProcess() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById('modal-success').classList.remove('active'); const endDate = new Date(state.startTime.getTime() + state.planHours * 60 * 60 * 1000); state.activeBooking = { car: state.selectedCar, endTime: endDate }; updateActiveBookingUI(); state.selectedCar.status = 'booked'; renderCars(); }
        function updateActiveBookingUI() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const panel = document.getElementById('active-booking-panel'); if(state.activeBooking) { panel.classList.remove('hidden'); document.getElementById('active-car-name').innerText = state.activeBooking.car.name; const end = state.activeBooking.endTime; document.getElementById('active-end-time').innerText = `${end.getHours()}:${(end.getMinutes()<10?'0':'') + end.getMinutes()}`; } else { panel.classList.add('hidden'); } }
        function openReturnModal() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById('modal-return').classList.add('active'); }
        function closeModal(id) { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById(id).classList.remove('active'); }
        function completeReturn() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById('modal-return').classList.remove('active'); state.activeBooking.car.status = 'available'; state.activeBooking = null; updateActiveBookingUI(); renderCars(); setTimeout(() => { document.getElementById('modal-return-success').classList.add('active'); }, 300); }
        function renderStamps() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const grid = document.getElementById('stamp-grid'); grid.innerHTML = ''; STAMP_DATA.forEach((stamp, index) => { const div = document.createElement('div'); div.className = `stamp-cell aspect-square rounded-xl flex flex-col items-center justify-center border-2 ${stamp.earned ? 'bg-white border-ncu-yellow shadow-sm' : 'bg-gray-100 border-dashed border-gray-300'}`; if (stamp.earned) { div.innerHTML = `<i data-lucide="check-circle" class="w-8 h-8 text-ncu-yellow fill-current"></i><span class="stamp-date">${stamp.date}</span>`; } else { div.innerHTML = `<span class="text-gray-300 font-bold text-xl">${index + 1}</span>`; } grid.appendChild(div); }); lucide.createIcons(); }
        function renderRewards() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const list = document.getElementById('reward-list'); list.innerHTML = ''; REWARD_DATA.forEach(reward => { const el = document.createElement('div'); el.className = 'flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition'; el.innerHTML = `<div class="bg-gray-100 p-2 rounded-full mr-3"><i data-lucide="${reward.icon}" class="w-5 h-5 text-gray-600"></i></div><div><h4 class="font-bold text-gray-800 text-sm">${reward.name}</h4><p class="text-xs text-gray-500">${reward.desc}</p></div><div class="ml-auto"><div class="w-5 h-5 rounded-full border-2 border-gray-300"></div></div>`; list.appendChild(el); }); lucide.createIcons(); }
        function openRewardModal() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ document.getElementById('modal-rewards').classList.add('active'); }
        function setupNavigation() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const navBtns = document.querySelectorAll('.nav-btn'); const screens = document.querySelectorAll('.screen'); navBtns.forEach(btn => { btn.addEventListener('click', () => { const targetId = btn.dataset.screen; screens.forEach(s => s.classList.remove('active')); document.getElementById(targetId).classList.add('active'); navBtns.forEach(b => { b.classList.remove('text-primary'); b.classList.add('text-gray-400'); }); btn.classList.add('text-primary'); btn.classList.remove('text-gray-400'); if(targetId === 'screen-home' && map) setTimeout(() => map.invalidateSize(), 300); }); }); }
        function renderHomeNews() { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const slider = document.getElementById('home-news-slider'); slider.innerHTML = ''; NEWS_DATA.slice(0, 5).forEach(news => { const el = document.createElement('div'); el.className = 'flex-shrink-0 w-64 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer hover:shadow-md transition'; el.onclick = () => openNewsModal(news); let headerContent = ''; if(news.category === 'event') headerContent = `<div class="h-24 bg-orange-100 flex items-center justify-center"><i data-lucide="calendar" class="w-8 h-8 text-orange-400"></i></div>`; else if(news.category === 'coupon') headerContent = `<div class="h-24 bg-pink-100 flex items-center justify-center"><i data-lucide="ticket" class="w-8 h-8 text-pink-400"></i></div>`; else headerContent = `<div class="h-24 bg-blue-100 flex items-center justify-center"><i data-lucide="info" class="w-8 h-8 text-blue-400"></i></div>`; if(news.image) headerContent = `<img src="${news.image}" class="w-full h-24 object-cover">`; el.innerHTML = `${headerContent}<div class="p-3"><div class="flex items-center mb-1"><span class="text-[10px] font-bold px-1.5 py-0.5 rounded text-white ${getCategoryColor(news.category)}">${getCategoryLabel(news.category)}</span><span class="text-[10px] text-gray-400 ml-auto">${news.date}</span></div><h4 class="text-xs font-bold text-gray-800 line-clamp-2">${news.title}</h4></div>`; slider.appendChild(el); }); }
        function renderNews(filter = 'all') { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const container = document.getElementById('news-list'); container.innerHTML = ''; const filteredData = filter === 'all' ? NEWS_DATA : NEWS_DATA.filter(n => n.category === filter); filteredData.forEach(news => { const el = document.createElement('div'); el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer flex items-start'; el.onclick = () => openNewsModal(news); el.innerHTML = `<div class="mr-3 mt-1"><div class="w-10 h-10 rounded-full flex items-center justify-center ${getCategoryBg(news.category)}"><i data-lucide="${getCategoryIcon(news.category)}" class="w-5 h-5 text-white"></i></div></div><div class="flex-grow"><div class="flex justify-between items-start mb-1"><span class="text-xs font-bold text-gray-500">${getCategoryLabel(news.category)}</span><span class="text-xs text-gray-400">${news.date}</span></div><h4 class="text-sm font-bold text-gray-800 leading-snug">${news.title}</h4></div>`; container.appendChild(el); }); lucide.createIcons(); }
        function getCategoryLabel(cat) { if (cat === 'app') return 'ã‚¢ãƒ—ãƒª'; if (cat === 'event') return 'ã‚¤ãƒ™ãƒ³ãƒˆ'; if (cat === 'coupon') return 'ã‚¯ãƒ¼ãƒãƒ³'; return 'ãã®ä»–'; }
        function getCategoryColor(cat) { if (cat === 'app') return 'bg-blue-500'; if (cat === 'event') return 'bg-secondary'; if (cat === 'coupon') return 'bg-pink-500'; return 'bg-gray-500'; }
        function getCategoryBg(cat) { if (cat === 'app') return 'bg-blue-500'; if (cat === 'event') return 'bg-secondary'; if (cat === 'coupon') return 'bg-pink-500'; return 'bg-gray-500'; }
        function getCategoryIcon(cat) { if (cat === 'app') return 'info'; if (cat === 'event') return 'calendar'; if (cat === 'coupon') return 'ticket'; return 'bell'; }
        function openNewsModal(news) { /* çœç•¥ï¼ˆVer13ã¨åŒã˜ï¼‰ */ const modal = document.getElementById('modal-news-detail'); document.getElementById('news-modal-title').innerText = news.title; document.getElementById('news-modal-date').innerText = news.date; document.getElementById('news-modal-content').innerText = news.content; const imgEl = document.getElementById('news-modal-img'); if(news.image) { imgEl.src = news.image; imgEl.classList.remove('hidden'); } else { imgEl.classList.add('hidden'); } const catEl = document.getElementById('news-modal-category'); catEl.innerText = getCategoryLabel(news.category); catEl.className = `text-xs font-bold px-2 py-1 rounded text-white ${getCategoryColor(news.category)}`; modal.classList.add('active'); }
    </script>
</body>
</html>
