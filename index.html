<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>名市大カーシェアアプリ_プロトタイプ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#00A7C7', 
                            dark: '#0089A1',
                        },
                        secondary: '#F5A623',
                        ncu: {
                            green: '#006A5C',
                            yellow: '#FDB813',
                        }
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)',
                    }
                },
            },
        };
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', 'sans-serif'; height: 100vh; display: flex; flex-direction: column; -webkit-tap-highlight-color: transparent; }
        main { flex-grow: 1; padding-bottom: calc(90px + env(safe-area-inset-bottom)); overflow-y: auto; scroll-behavior: smooth; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        #app-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
        
        /* モーダル関連 */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: end; transition: opacity 0.2s; opacity: 0; pointer-events: none;}
        @media (min-width: 640px) { .modal { align-items: center; } }
        
        .modal.active { display: flex; opacity: 1; pointer-events: auto; }
        .modal-content { background: white; border-radius: 20px 20px 0 0; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; padding-bottom: max(20px, env(safe-area-inset-bottom)); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal.active .modal-content { transform: translateY(0); }
        @media (min-width: 640px) { 
            .modal-content { border-radius: 12px; width: 90%; transform: scale(0.95); opacity: 0; transition: all 0.2s; } 
            .modal.active .modal-content { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #map-container { height: 250px; z-index: 1; }
        .leaflet-touch .leaflet-control-attribution { font-size: 8px; }

        /* スケジュールバー */
        .schedule-bar { height: 32px; border-radius: 6px; overflow: hidden; display: flex; background: #f3f4f6; position: relative; box-shadow: inner 0 2px 4px rgba(0,0,0,0.05); }
        .schedule-segment { height: 100%; transition: width 0.3s, left 0.3s; }
        .schedule-segment.booked { 
            background: repeating-linear-gradient(45deg, #ef4444, #ef4444 5px, #f87171 5px, #f87171 10px); 
        } 
        .schedule-segment.selected { background-color: #3b82f6; opacity: 0.9; box-shadow: 0 0 10px rgba(59,130,246,0.5); z-index: 10;} 
        .schedule-label { position: absolute; bottom: -22px; font-size: 10px; color: #9ca3af; transform: translateX(-50%); white-space: nowrap; }

        /* クーポン券スタイル */
        .coupon-ticket {
            background: radial-gradient(circle at left, transparent 10px, #fff 10px) left,
                        radial-gradient(circle at right, transparent 10px, #fff 10px) right;
            background-size: 51% 100%;
            background-repeat: no-repeat;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.05));
            transition: transform 0.2s;
        }
        .coupon-ticket:active { transform: scale(0.98); }

        /* 通知トースト */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(30, 41, 59, 0.95); color: white; padding: 12px 20px; border-radius: 50px; margin-bottom: 10px; font-size: 14px; font-weight: bold; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.3s; pointer-events: auto; display: flex; items-center: center; justify-content: center;}
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #ef4444; }

        .horizontal-scroll { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        .horizontal-card { flex: 0 0 85%; scroll-snap-align: center; margin-right: 12px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 select-none">

    <!-- 通知エリア -->
    <div id="toast-container"></div>

    <!-- ヘッダー -->
    <header class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 transition-all duration-300" id="main-header">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2" onclick="resetAppDebug()">
                <i data-lucide="car-front" class="text-ncu-green"></i>
                <div class="text-lg font-bold text-ncu-green tracking-tight">
                    名市大ドライブ<span class="text-secondary">GOGO</span>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-xs text-right hidden sm:block">
                    <p class="font-bold text-gray-700">名市大 太郎</p>
                    <p class="text-gray-400">一般会員</p>
                </div>
                <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 overflow-hidden border border-gray-100">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </div>
            </div>
        </nav>
    </header>

    <!-- メインコンテンツ -->
    <main class="container mx-auto relative">

        <!-- 画面：ホーム -->
        <section id="screen-home" class="screen active p-4">
            
            <!-- 利用中ステータスパネル -->
            <div id="active-booking-panel" class="hidden bg-ncu-green text-white p-5 rounded-2xl shadow-xl shadow-ncu-green/20 mb-6 border-l-4 border-secondary relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-white/10 rotate-12">
                    <i data-lucide="car" class="w-32 h-32"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold flex items-center text-sm uppercase tracking-wider opacity-90"><i data-lucide="key" class="w-4 h-4 mr-2"></i>Current Drive</h3>
                        <span class="text-[10px] bg-white text-ncu-green px-2 py-1 rounded-full font-bold shadow-sm animate-pulse">利用中</span>
                    </div>
                    <p id="active-car-name" class="text-xl font-bold mb-1 tracking-tight">車種名</p>
                    <div class="flex items-end space-x-2 mb-4">
                        <p class="text-sm opacity-90">返却予定</p>
                        <p id="active-end-time" class="font-mono text-2xl font-bold leading-none">15:00</p>
                    </div>
                    <button onclick="openReturnModal()" class="w-full bg-white text-ncu-green font-bold py-3 rounded-xl shadow-md hover:bg-gray-50 transition flex items-center justify-center active:scale-[0.98]">
                        <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                        返却手続きへ
                    </button>
                </div>
            </div>

            <!-- スタンプラリー進捗 -->
            <div class="mb-6">
                <div class="bg-gradient-to-r from-ncu-green to-teal-700 rounded-2xl p-5 shadow-lg shadow-teal-700/20 text-white relative overflow-hidden cursor-pointer transform transition active:scale-[0.98]" onclick="navigateTo('screen-stamp')">
                    <div class="absolute top-0 right-0 opacity-10">
                        <i data-lucide="award" class="w-32 h-32 -mr-8 -mt-8"></i>
                    </div>
                    <div class="flex justify-between items-end relative z-10 mb-4">
                        <div>
                            <p class="text-[10px] font-bold text-ncu-yellow mb-1 tracking-widest border border-ncu-yellow/50 inline-block px-2 py-0.5 rounded-full">STAMP RALLY</p>
                            <h2 class="text-2xl font-bold mt-1">あと<span class="text-4xl mx-1 text-ncu-yellow font-mono" id="home-stamp-remaining">7</span>個で達成！</h2>
                        </div>
                        <div class="bg-white/20 p-2.5 rounded-xl backdrop-blur-sm shadow-inner">
                            <i data-lucide="qr-code" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs opacity-80 mb-1 font-mono">
                            <span>Progress</span>
                            <span id="home-stamp-fraction">2 / 9</span>
                        </div>
                        <div class="w-full bg-black/20 rounded-full h-2 relative overflow-hidden">
                            <div id="home-stamp-bar" class="bg-ncu-yellow h-full rounded-full shadow-[0_0_10px_rgba(253,184,19,0.5)] transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- お知らせ -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <i data-lucide="megaphone" class="w-5 h-5 mr-2 text-secondary"></i>News
                    </h3>
                    <button class="text-xs text-primary font-bold hover:underline" onclick="navigateTo('screen-news')">すべて見る</button>
                </div>
                <div class="horizontal-scroll no-scrollbar" id="home-news-container">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- マップ & 車両予約 -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-gray-600 flex items-center">
                        <i data-lucide="map" class="w-4 h-4 mr-1"></i>車両を探す
                    </h3>
                    <button onclick="getCurrentLocation()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-full flex items-center transition">
                        <i data-lucide="crosshair" class="w-3 h-3 mr-1"></i>現在地
                    </button>
                </div>
                <div id="map-container" class="rounded-xl overflow-hidden h-56 mb-5 border border-gray-200 relative z-0">
                    <!-- Leaflet Map -->
                </div>
                
                <h4 class="text-sm font-bold text-gray-700 mb-3 ml-1">利用可能な車両</h4>
                <div id="car-list-container" class="space-y-3">
                    <!-- JS Generated -->
                </div>
            </div>
        </section>

        <!-- 画面：スタンプラリー -->
        <section id="screen-stamp" class="screen p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="award" class="mr-2 text-secondary"></i>スタンプラリー
            </h2>
            <div class="bg-gradient-to-br from-ncu-green to-teal-800 p-6 rounded-2xl shadow-lg text-white text-center mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <p class="text-sm opacity-90 mb-1 relative z-10">現在の獲得数</p>
                <div class="text-6xl font-bold mb-2 relative z-10 font-mono tracking-tighter" id="stamp-count-large">0</div>
                <div class="flex justify-center items-center text-sm opacity-80 mb-4 relative z-10">
                    <span class="mr-2">Total Goal: 9</span>
                </div>
                <button onclick="openRewardModal()" class="w-full bg-white/10 backdrop-blur-md border border-white/30 text-white text-sm font-bold py-3 rounded-xl hover:bg-white/20 transition flex items-center justify-center relative z-10">
                    <i data-lucide="gift" class="w-4 h-4 mr-2"></i>
                    達成報酬を見る
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-8" id="stamp-grid">
                <!-- JS Generated -->
            </div>

            <button onclick="simulateScanQR()" class="w-full bg-secondary text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-200 hover:bg-orange-500 transition active:scale-[0.98] flex items-center justify-center space-x-2 mb-8">
                <i data-lucide="qr-code" class="w-6 h-6"></i>
                <span>QRコードを読み取る</span>
            </button>
        </section>

        <!-- 画面：クーポン -->
        <section id="screen-coupon" class="screen p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="ticket" class="mr-2 text-secondary"></i>マイクーポン
            </h2>
            <div class="flex mb-6 bg-gray-100 p-1 rounded-xl">
                <button class="coupon-tab flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-primary transition" data-target="active-coupons">利用可能</button>
                <button class="coupon-tab flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 transition hover:bg-gray-50" data-target="used-coupons">履歴</button>
            </div>
            <div id="active-coupons" class="space-y-4 min-h-[200px]"></div>
            <div id="used-coupons" class="space-y-4 hidden opacity-60 min-h-[200px]"></div>
        </section>

        <!-- 画面：お知らせ -->
        <section id="screen-news" class="screen p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="bell" class="mr-2 text-secondary"></i>お知らせ
            </h2>
            <div class="flex overflow-x-auto space-x-2 mb-4 pb-2 no-scrollbar">
                <button class="news-tab px-4 py-2 rounded-full text-sm font-bold bg-ncu-green text-white transition whitespace-nowrap shadow-sm" data-filter="all">すべて</button>
                <button class="news-tab px-4 py-2 rounded-full text-sm font-bold bg-white border border-gray-200 text-gray-500 transition whitespace-nowrap" data-filter="app">アプリ</button>
                <button class="news-tab px-4 py-2 rounded-full text-sm font-bold bg-white border border-gray-200 text-gray-500 transition whitespace-nowrap" data-filter="event">イベント</button>
                <button class="news-tab px-4 py-2 rounded-full text-sm font-bold bg-white border border-gray-200 text-gray-500 transition whitespace-nowrap" data-filter="coupon">クーポン</button>
            </div>
            <div id="news-list" class="space-y-3 mb-20">
                <!-- JS Generated -->
            </div>
        </section>

        <!-- 画面：マイページ -->
        <section id="screen-mypage" class="screen p-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6 flex items-center space-x-4">
                <div class="bg-gray-100 p-4 rounded-full">
                    <i data-lucide="user" class="w-8 h-8 text-gray-400"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold">名市大 太郎</h3>
                    <p class="text-xs text-gray-500 font-mono mt-1">ID: 22113000</p>
                    <p class="text-xs text-ncu-green font-bold mt-1">経済学部 / 一般会員</p>
                </div>
            </div>
            <div class="space-y-3">
                <button class="w-full flex justify-between items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:bg-gray-50 active:scale-[0.99] transition">
                    <span class="flex items-center text-sm font-semibold text-gray-700"><i data-lucide="history" class="w-5 h-5 mr-3 text-primary"></i>利用履歴</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                </button>
                <button class="w-full flex justify-between items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:bg-gray-50 active:scale-[0.99] transition">
                    <span class="flex items-center text-sm font-semibold text-gray-700"><i data-lucide="credit-card" class="w-5 h-5 mr-3 text-gray-500"></i>お支払い方法</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                </button>
                <button class="w-full flex justify-between items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:bg-gray-50 active:scale-[0.99] transition" onclick="resetAppDebug()">
                    <span class="flex items-center text-sm font-semibold text-gray-700"><i data-lucide="database-zap" class="w-5 h-5 mr-3 text-red-400"></i>デバッグ: データ初期化</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                </button>
            </div>
            <button class="mt-8 w-full py-4 text-red-500 text-sm font-bold border border-red-100 bg-red-50 rounded-xl hover:bg-red-100 transition">
                ログアウト
            </button>
            <p class="text-center text-[10px] text-gray-300 mt-6">Ver 13.2.0 (Build 20231128)</p>
        </section>

    </main>

    <!-- フッターナビ -->
    <footer id="app-footer" class="bg-white border-t border-gray-200">
        <div class="container mx-auto px-1 py-2 flex justify-between">
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-primary transition-colors" data-screen="screen-home">
                <i data-lucide="home" class="w-6 h-6 mb-1 transition-transform duration-200"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">ホーム</span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-stamp">
                <i data-lucide="stamp" class="w-6 h-6 mb-1 transition-transform duration-200"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">スタンプ</span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-coupon">
                <i data-lucide="ticket" class="w-6 h-6 mb-1 transition-transform duration-200"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">クーポン</span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-news">
                <i data-lucide="bell" class="w-6 h-6 mb-1 transition-transform duration-200"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">お知らせ</span>
            </button>
            <button class="nav-btn flex-1 py-1 flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors" data-screen="screen-mypage">
                <i data-lucide="user" class="w-6 h-6 mb-1 transition-transform duration-200"></i>
                <span class="text-[10px] font-bold transform scale-90 sm:scale-100">マイページ</span>
            </button>
        </div>
    </footer>

    <!-- ===== モーダル ===== -->

    <!-- お知らせ詳細 -->
    <div id="modal-news-detail" class="modal">
        <div class="modal-content p-6">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span id="news-modal-category" class="text-[10px] font-bold px-2 py-1 rounded text-white bg-gray-500 tracking-wide">APP</span>
                    <span id="news-modal-date" class="text-xs text-gray-400 ml-2 font-mono">2023/11/25</span>
                </div>
                <button onclick="closeModal('modal-news-detail')" class="bg-gray-100 p-1.5 rounded-full text-gray-500 hover:bg-gray-200">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <h3 id="news-modal-title" class="text-lg font-bold text-gray-800 mb-4 leading-tight">タイトル</h3>
            <div id="news-modal-content" class="text-sm text-gray-600 leading-relaxed space-y-2 mb-8 bg-gray-50 p-4 rounded-xl border border-gray-100">
                <!-- 内容 -->
            </div>
            <button onclick="closeModal('modal-news-detail')" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl hover:bg-black transition active:scale-[0.98]">閉じる</button>
        </div>
    </div>

    <!-- 報酬選択 -->
    <div id="modal-rewards" class="modal">
        <div class="modal-content p-5">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-4"></div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i data-lucide="gift" class="mr-2 text-secondary"></i>達成報酬カタログ</h3>
            </div>
            <p class="text-xs text-gray-600 mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200 leading-relaxed">
                スタンプを<span class="font-bold text-yellow-700">9個</span>集めると、以下のリストからお好きな景品を1つお選びいただけます。<br>
                <span class="text-[10px] opacity-70">※交換後の取り消しはできません</span>
            </p>
            <div class="space-y-3 mb-6" id="reward-list"></div>
            <button onclick="closeModal('modal-rewards')" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">閉じる</button>
        </div>
    </div>

    <!-- クーポン使用確認 -->
    <div id="modal-use-coupon" class="modal">
        <div class="modal-content p-6 text-center">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="ticket" class="w-8 h-8 text-secondary"></i>
            </div>
            <h2 class="text-lg font-bold mb-2 text-gray-800">クーポンを使用しますか？</h2>
            <p class="text-xs text-gray-500 mb-6">店舗スタッフにこの画面を提示してください。<br>「使用する」を押すと無効化されます。</p>
            <div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-200">
                <p id="modal-coupon-title" class="font-bold text-base text-gray-800 mb-1">クーポン名</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeModal('modal-use-coupon')" class="flex-1 bg-gray-100 text-gray-700 font-bold py-3.5 rounded-xl">キャンセル</button>
                <button id="btn-confirm-use-coupon" class="flex-1 bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-primary/30">使用する</button>
            </div>
        </div>
    </div>

    <!-- 予約ウィザード -->
    <div id="modal-booking-wizard" class="modal">
        <div class="modal-content !p-0 overflow-hidden flex flex-col h-[90vh]">
            <!-- Header Image -->
            <div class="relative h-48 bg-gray-200 flex-shrink-0">
                <img id="wizard-car-img" src="" alt="Vehicle" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                <button onclick="closeModal('modal-booking-wizard')" class="absolute top-4 right-4 bg-black/40 text-white rounded-full p-2 backdrop-blur-sm z-10 hover:bg-black/60 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <div class="absolute bottom-4 left-4 text-white pr-4">
                    <span class="inline-block px-2 py-0.5 bg-ncu-green text-[10px] font-bold rounded mb-1">シェアカー</span>
                    <h2 id="wizard-car-name" class="text-xl font-bold leading-tight">Car Name</h2>
                    <p class="text-xs opacity-80 flex items-center mt-1"><i data-lucide="map-pin" class="w-3 h-3 mr-1"></i>滝子キャンパス</p>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-grow overflow-y-auto p-5 pb-24 bg-white">
                
                <!-- Stepper -->
                <div class="flex items-center justify-between mb-8 px-4">
                    <div class="flex flex-col items-center relative z-10">
                        <div id="step-dot-1" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-md transition-colors duration-300">1</div>
                        <span class="text-[10px] mt-2 text-gray-500 font-bold">プラン</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-100 -mx-2 relative top-[-8px]">
                        <div id="step-line-1" class="h-full bg-primary transition-all duration-500 w-0"></div>
                    </div>
                    <div class="flex flex-col items-center relative z-10">
                        <div id="step-dot-2" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center font-bold text-sm transition-colors duration-300">2</div>
                        <span class="text-[10px] mt-2 text-gray-400 font-bold">日時</span>
                    </div>
                </div>

                <!-- STEP 1: Plan -->
                <div id="step-content-1" class="step-content">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">料金プラン選択</h3>
                    <div class="space-y-3">
                        <label class="relative flex items-center justify-between p-4 border-2 border-gray-100 bg-white rounded-xl cursor-pointer transition-all duration-200 shadow-sm group select-none">
                            <input type="radio" name="plan" value="0.5" class="peer hidden">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-primary flex items-center justify-center mr-3 group-hover:border-primary">
                                    <div class="w-2.5 h-2.5 rounded-full bg-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                </div>
                                <div>
                                    <span class="block text-sm font-bold text-gray-800">短時間 (30分)</span>
                                    <span class="block text-[10px] text-gray-500">お試し利用に</span>
                                </div>
                            </div>
                            <span class="text-lg font-bold text-primary font-mono">150<span class="text-xs text-gray-500 font-sans ml-1">円</span></span>
                            <div class="absolute inset-0 border-2 border-primary rounded-xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></div>
                        </label>

                        <label class="relative flex items-center justify-between p-4 border-2 border-gray-100 bg-white rounded-xl cursor-pointer transition-all duration-200 shadow-sm group select-none">
                            <input type="radio" name="plan" value="2" checked class="peer hidden">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-primary flex items-center justify-center mr-3 group-hover:border-primary">
                                    <div class="w-2.5 h-2.5 rounded-full bg-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                </div>
                                <div>
                                    <span class="block text-sm font-bold text-gray-800">2時間パック</span>
                                    <span class="block text-[10px] text-gray-500">一番人気プラン</span>
                                </div>
                            </div>
                            <span class="text-lg font-bold text-primary font-mono">500<span class="text-xs text-gray-500 font-sans ml-1">円</span></span>
                            <div class="absolute inset-0 border-2 border-primary rounded-xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></div>
                            <div class="absolute -top-2 right-2 bg-secondary text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">POPULAR</div>
                        </label>

                        <label class="relative flex items-center justify-between p-4 border-2 border-gray-100 bg-white rounded-xl cursor-pointer transition-all duration-200 shadow-sm group select-none">
                            <input type="radio" name="plan" value="6" class="peer hidden">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-primary flex items-center justify-center mr-3 group-hover:border-primary">
                                    <div class="w-2.5 h-2.5 rounded-full bg-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                </div>
                                <div>
                                    <span class="block text-sm font-bold text-gray-800">6時間パック</span>
                                    <span class="block text-[10px] text-gray-500">遠出に最適</span>
                                </div>
                            </div>
                            <span class="text-lg font-bold text-primary font-mono">1,000<span class="text-xs text-gray-500 font-sans ml-1">円</span></span>
                            <div class="absolute inset-0 border-2 border-primary rounded-xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></div>
                        </label>
                    </div>
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100">
                        <button onclick="goToStep(2)" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 hover:bg-primary-dark transition active:scale-[0.98]">次へ進む</button>
                    </div>
                </div>

                <!-- STEP 2: Date & Time -->
                <div id="step-content-2" class="step-content hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">利用開始時間</h3>
                    
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-6">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-xs font-bold text-gray-500">本日 (0:00 - 24:00)</span>
                            <div class="flex items-center text-[10px] space-x-2">
                                <span class="flex items-center"><span class="w-2 h-2 bg-red-500 rounded-sm mr-1"></span>不可</span>
                                <span class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-sm mr-1"></span>選択中</span>
                            </div>
                        </div>
                        <div id="schedule-bar-container" class="schedule-bar border border-gray-200 mb-6"></div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button id="btn-now" class="border-2 border-secondary bg-orange-50 p-3 rounded-lg text-center hover:bg-orange-100 transition active:scale-[0.98] relative overflow-hidden">
                                <div class="relative z-10">
                                    <i data-lucide="zap" class="w-5 h-5 text-secondary mx-auto mb-1"></i>
                                    <span class="block text-xs font-bold text-secondary">今すぐ</span>
                                </div>
                            </button>
                            <button id="btn-later" class="border-2 border-gray-200 bg-white p-3 rounded-lg text-center hover:bg-gray-50 transition active:scale-[0.98]">
                                <i data-lucide="clock" class="w-5 h-5 text-gray-400 mx-auto mb-1"></i>
                                <span class="block text-xs font-bold text-gray-600">時間指定</span>
                            </button>
                        </div>
                        
                        <div id="custom-time-input" class="hidden animate-fadeIn">
                            <label class="block text-xs font-bold text-gray-500 mb-1">開始日時を指定</label>
                            <input type="datetime-local" id="input-start-time" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-sm font-mono shadow-inner outline-none focus:ring-2 focus:ring-primary/50">
                        </div>
                    </div>

                    <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 mb-20">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-500">開始</span>
                            <span id="wizard-start-time" class="font-bold font-mono text-gray-800">--:--</span>
                        </div>
                        <div class="flex justify-between text-sm border-t border-dashed border-blue-200 pt-2">
                            <span class="text-gray-500">終了(予定)</span>
                            <span id="wizard-end-time" class="font-bold font-mono text-gray-800">--:--</span>
                        </div>
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100 flex space-x-3">
                        <button onclick="goToStep(1)" class="w-1/3 bg-gray-100 text-gray-600 font-bold py-3.5 rounded-xl hover:bg-gray-200 transition">戻る</button>
                        <button onclick="confirmBooking()" class="w-2/3 bg-secondary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-500/30 hover:bg-orange-600 transition active:scale-[0.98]">予約を確定する</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 予約完了 -->
    <div id="modal-success" class="modal">
        <div class="modal-content p-8 text-center rounded-2xl">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 relative">
                <div class="absolute inset-0 bg-green-100 rounded-full animate-ping opacity-20"></div>
                <i data-lucide="check" class="w-10 h-10 text-green-600"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">予約完了！</h2>
            <p class="text-sm text-gray-500 mb-8">予約が確定しました。<br>開始時間になりましたら解錠してください。</p>
            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-8 relative overflow-hidden group cursor-pointer" onclick="navigator.clipboard.writeText('8931'); showToast('コピーしました')">
                <div class="absolute top-0 left-0 w-1 h-full bg-ncu-green"></div>
                <p class="text-[10px] text-gray-400 mb-1 font-bold uppercase tracking-widest">Unlock Code</p>
                <div class="flex items-center justify-center">
                    <p class="text-4xl font-mono font-bold text-gray-800 tracking-[0.3em] ml-2">8931</p>
                    <i data-lucide="copy" class="w-4 h-4 ml-2 text-gray-300 group-hover:text-primary transition"></i>
                </div>
            </div>
            <button onclick="finishBookingProcess()" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl hover:bg-black transition shadow-lg">ホームへ戻る</button>
        </div>
    </div>

    <!-- 返却手続き -->
    <div id="modal-return" class="modal">
        <div class="modal-content p-6 text-center">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-xl font-bold mb-4">返却手続き</h2>
            <div class="text-left bg-gray-50 p-4 rounded-xl mb-6 text-sm text-gray-600 space-y-2 border border-gray-100">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-ncu-green rounded focus:ring-ncu-green" id="check-return-1">
                    <span>元の駐車スペースに戻しました</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-ncu-green rounded focus:ring-ncu-green" id="check-return-2">
                    <span>ライト消灯、窓閉めを確認しました</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-ncu-green rounded focus:ring-ncu-green" id="check-return-3">
                    <span>車内の忘れ物はありません</span>
                </label>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeModal('modal-return')" class="flex-1 bg-gray-100 text-gray-700 font-bold py-3.5 rounded-xl">キャンセル</button>
                <button onclick="completeReturn()" class="flex-1 bg-ncu-green text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-700/20">返却する</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. 定数・データ定義 ---
        const CONSTANTS = {
            APP_KEY: 'ncu_drive_app_v13_2_data', // LocalStorage Key
        };

        const INITIAL_DATA = {
            stamps: [
                { id: 1, earned: true, date: '11/02' },
                { id: 2, earned: true, date: '11/15' },
                { id: 3, earned: false, date: null },
                { id: 4, earned: false, date: null },
                { id: 5, earned: false, date: null },
                { id: 6, earned: false, date: null },
                { id: 7, earned: false, date: null },
                { id: 8, earned: false, date: null },
                { id: 9, earned: false, date: null }
            ],
            coupons: [
                { id: 1, title: "初回利用割引", discount: "500円OFF", desc: "初回利用限定", expire: "2025/12/31", status: "active" },
                { id: 2, title: "犬山食べ歩き", discount: "クーポン券", desc: "犬山城下町対象店舗", expire: "2025/03/31", status: "active" },
                { id: 3, title: "誕生日クーポン", discount: "20%OFF", desc: "お誕生日月限定", expire: "2025/01/31", status: "active" },
                { id: 4, title: "長時間パック割", discount: "10%OFF", desc: "6時間以上のご利用で適用", expire: "2024/11/01", status: "used" }
            ],
            // 永続化したい車両状態（予約のみ）
            bookings: [] // { carId: 1, start: timestamp, end: timestamp }
        };

        // 静的データ（変更されないもの）
        const MASTER_CARS = [
            { id: 1, name: "ダイハツ ミライース (A)", location: "滝子キャンパス・東駐輪場横", image: "https://placehold.co/400x250/00A7C7/FFFFFF?text=MIRA+A", capacity: 4, baseSchedule: [[10, 13]] },
            { id: 2, name: "ダイハツ ミライース (B)", location: "滝子キャンパス・正門ロータリー", image: "https://placehold.co/400x250/0089A1/FFFFFF?text=MIRA+B", capacity: 4, baseSchedule: [] },
            { id: 3, name: "トヨタ アクア", location: "滝子キャンパス・東駐輪場横", image: "https://placehold.co/400x250/F5A623/FFFFFF?text=AQUA", capacity: 5, baseSchedule: [[0, 9]] }, // 朝予約済み
            { id: 4, name: "トヨタ ヴォクシー", location: "滝子キャンパス・部室棟付近", image: "https://placehold.co/400x250/006A5C/FFFFFF?text=VOXY", capacity: 8, baseSchedule: [[14, 18], [20, 22]] }
        ];

        const NEWS_DATA = [
            { id: 1, date: '11/25', category: 'coupon', title: '【コメダ珈琲】スタンプラリー達成でドリンク無料券！', content: '桜山店限定！スタンプラリーの画面を見せるとドリンク1杯サービス。' },
            { id: 2, date: '11/20', category: 'event', title: '【犬山観光協会】秋の城下町まつり開催中！', content: '犬山城下町にて秋のイベントが開催中です。ドライブでお出かけください！' },
            { id: 3, date: '11/15', category: 'event', title: '【蒲郡】ラグーナ・イルミネーション開始', content: '冬のラグーナテンボスはイルミネーションが綺麗です。' },
            { id: 4, date: '11/10', category: 'app', title: 'アプリVer13.0リリース', content: 'ホーム画面が見やすくなりました。' }
        ];

        const REWARD_DATA = [
            { id: 1, name: "生協利用券 500円分", icon: "shopping-basket", desc: "学内の生協食堂・売店で利用可能" },
            { id: 2, name: "2時間パック無料券 × 2枚", icon: "clock", desc: "ちょっとしたお出かけに便利" },
            { id: 3, name: "終日パック無料券", icon: "calendar-check", desc: "1日中自由に使える最強チケット" }
        ];

        const SPONSOR_DATA = [
            { name: "名市大 滝子キャンパス (出発地)", lat: 35.1385, lng: 136.9325, type: "campus" },
            { name: "熱田イオンモール", lat: 35.1332, lng: 136.9056, type: "spot" },
            { name: "コメダ珈琲店 (桜山店)", lat: 35.1415, lng: 136.9335, type: "cafe" },
            { name: "犬山観光協会 (犬山城)", lat: 35.3886, lng: 136.9392, type: "tourism" },
            { name: "蒲郡市観光協会", lat: 34.8085, lng: 137.2724, type: "tourism" },
            { name: "知多半島観光協会", lat: 34.7175, lng: 136.9450, type: "tourism" }
        ];

        // --- 2. ステート管理 (LocalStorage対応) ---
        let appState = {
            stamps: [],
            coupons: [],
            bookings: [],
            activeBooking: null, // 現在利用中のもの { carId, endTime }
            // UI State
            selectedCar: null,
            wizardStartTime: new Date(),
            wizardPlanHours: 2,
            selectedCoupon: null
        };

        function loadState() {
            const saved = localStorage.getItem(CONSTANTS.APP_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                // 日付文字列をDateオブジェクトに戻す処理が必要ならここで行う
                if(parsed.activeBooking) parsed.activeBooking.endTime = new Date(parsed.activeBooking.endTime);
                appState = { ...appState, ...parsed };
            } else {
                appState = { ...appState, ...INITIAL_DATA };
            }
        }

        function saveState() {
            localStorage.setItem(CONSTANTS.APP_KEY, JSON.stringify({
                stamps: appState.stamps,
                coupons: appState.coupons,
                bookings: appState.bookings,
                activeBooking: appState.activeBooking
            }));
        }

        // デバッグ用リセット
        window.resetAppDebug = function() {
            if(confirm('アプリデータを初期化しますか？')) {
                localStorage.removeItem(CONSTANTS.APP_KEY);
                location.reload();
            }
        };

        // --- 3. ユーティリティ ---
        // XSS対策用エスケープ
        function escapeHtml(unsafe) {
            return String(unsafe)
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function showToast(msg, isError = false) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${isError ? 'error' : ''}`;
            el.innerHTML = isError ? `<i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>${escapeHtml(msg)}` : `<i data-lucide="check" class="w-4 h-4 mr-2"></i>${escapeHtml(msg)}`;
            container.appendChild(el);
            lucide.createIcons();
            
            // Reflow trigger
            void el.offsetWidth;
            el.classList.add('show');

            setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- 4. 初期化 ---
        document.addEventListener("DOMContentLoaded", () => {
            loadState();
            
            lucide.createIcons();
            initMap();
            
            renderHome();
            renderCars();
            renderCoupons();
            renderRewards();
            renderNews();
            
            setupNavigation();
            setupInteractions();
            
            // 時間初期化 (次の15分単位)
            const now = new Date();
            now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15, 0, 0); 
            document.getElementById('input-start-time').value = toLocalISOString(now);
            
            updateActiveBookingUI();
        });

        function toLocalISOString(date) {
            const pad = (num) => (num < 10 ? '0' : '') + num;
            return date.getFullYear() +
                '-' + pad(date.getMonth() + 1) +
                '-' + pad(date.getDate()) +
                'T' + pad(date.getHours()) +
                ':' + pad(date.getMinutes());
        }

        // --- 5. UIレンダリング ---
        
        function renderHome() {
            // スタンプ表示
            const earnedCount = appState.stamps.filter(s => s.earned).length;
            document.getElementById('home-stamp-remaining').textContent = 9 - earnedCount;
            document.getElementById('home-stamp-fraction').textContent = `${earnedCount} / 9`;
            document.getElementById('home-stamp-bar').style.width = `${(earnedCount / 9) * 100}%`;
            
            // スタンプ画面用
            document.getElementById('stamp-count-large').textContent = earnedCount;
            const grid = document.getElementById('stamp-grid');
            grid.innerHTML = '';
            appState.stamps.forEach((stamp, index) => {
                const div = document.createElement('div');
                div.className = `stamp-cell aspect-square rounded-xl flex flex-col items-center justify-center border-2 transition-all duration-500 ${stamp.earned ? 'bg-white border-ncu-yellow shadow-sm scale-100' : 'bg-gray-100 border-dashed border-gray-300 scale-95 opacity-70'}`;
                if (stamp.earned) {
                    div.innerHTML = `<i data-lucide="check-circle" class="w-8 h-8 text-ncu-yellow fill-current mb-1"></i><span class="text-[10px] font-bold text-ncu-green bg-green-50 px-1 rounded">${stamp.date}</span>`;
                } else {
                    div.innerHTML = `<span class="text-gray-300 font-bold text-xl">${index + 1}</span>`;
                }
                grid.appendChild(div);
            });

            // ニュース表示
            const newsContainer = document.getElementById('home-news-container');
            newsContainer.innerHTML = '';
            NEWS_DATA.slice(0, 3).forEach(news => { // 最新3件
                const el = document.createElement('div');
                el.className = 'horizontal-card bg-white p-3 rounded-xl shadow-sm border border-gray-100 cursor-pointer active:scale-[0.98] transition';
                el.onclick = () => openNewsModal(news);
                let catColor = news.category === 'event' ? 'bg-secondary' : (news.category === 'coupon' ? 'bg-pink-500' : 'bg-gray-500');
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] text-white font-bold px-1.5 py-0.5 rounded ${catColor}">${news.category.toUpperCase()}</span>
                        <span class="text-[10px] text-gray-400">${news.date}</span>
                    </div>
                    <h4 class="text-xs font-bold text-gray-800 leading-snug line-clamp-2">${escapeHtml(news.title)}</h4>
                `;
                newsContainer.appendChild(el);
            });
        }

        // --- 6. マップ ---
        let map;
        let userMarker = null;

        function initMap() {
            map = L.map('map-container', { zoomControl: false }).setView([35.1385, 136.9325], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

            SPONSOR_DATA.forEach(spot => {
                let color = '#00A7C7'; // Default
                if(spot.type === 'campus') color = '#006A5C';
                if(spot.type === 'tourism') color = '#F5A623';

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [16, 16],
                });
                L.marker([spot.lat, spot.lng], {icon: icon}).addTo(map)
                 .bindPopup(`<b style="font-size:12px">${escapeHtml(spot.name)}</b>`);
            });
        }

        window.getCurrentLocation = function() {
            if (!navigator.geolocation) {
                showToast("GPSが利用できません", true);
                return;
            }
            showToast("現在地を取得中...");
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    if (userMarker) map.removeLayer(userMarker);
                    
                    userMarker = L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            html: '<div style="width:16px; height:16px; background:#3b82f6; border-radius:50%; border:2px solid white; box-shadow:0 0 0 4px rgba(59,130,246,0.3);"></div>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map);
                    
                    map.flyTo([latitude, longitude], 15);
                    showToast("現在地を表示しました");
                },
                () => showToast("位置情報の取得に失敗しました", true)
            );
        };

        // --- 7. 車両リスト & 予約ロジック ---
        function renderCars() {
            const container = document.getElementById('car-list-container');
            container.innerHTML = '';
            const now = new Date();

            MASTER_CARS.forEach(car => {
                // 予約状況チェック（簡易）
                // 現在時刻が含まれる予約があるか？
                const isBookedNow = isCarBookedAt(car.id, now);
                const isMyActiveCar = appState.activeBooking && appState.activeBooking.carId === car.id;
                
                const card = document.createElement('div');
                card.className = `bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-3 transition ${isBookedNow && !isMyActiveCar ? 'opacity-60 bg-gray-50' : 'hover:shadow-md'}`;
                
                let btnHtml;
                if (isMyActiveCar) {
                     btnHtml = `<button class="w-full bg-ncu-green text-white font-bold py-2 px-3 rounded-lg text-xs" onclick="document.querySelector('#active-booking-panel').scrollIntoView({behavior:'smooth'})">利用中</button>`;
                } else if (isBookedNow) {
                     btnHtml = `<button disabled class="w-full bg-gray-200 text-gray-500 font-bold py-2 px-3 rounded-lg cursor-not-allowed text-xs">予約不可</button>`;
                } else {
                     btnHtml = `<button class="open-wizard-btn w-full bg-primary text-white font-bold py-2 px-3 rounded-lg hover:bg-primary-dark transition shadow-sm flex items-center justify-center text-xs">予約する</button>`;
                }

                card.innerHTML = `
                    <div class="relative w-28 h-20 flex-shrink-0">
                        <img src="${car.image}" class="w-full h-full object-cover rounded-lg bg-gray-200">
                        ${isBookedNow ? '<div class="absolute inset-0 bg-black/30 rounded-lg flex items-center justify-center"><span class="bg-black/70 text-white text-[10px] px-2 py-1 rounded">利用中</span></div>' : ''}
                    </div>
                    <div class="flex-grow flex flex-col justify-between py-0.5">
                        <div>
                            <h4 class="font-bold text-sm text-gray-800 leading-tight">${escapeHtml(car.name)}</h4>
                            <p class="text-[10px] text-gray-500 mt-0.5">${escapeHtml(car.location)}</p>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-[10px] text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">${car.capacity}人乗り</span>
                            <div class="w-20">${btnHtml}</div>
                        </div>
                    </div>
                `;
                
                if(!isBookedNow && !isMyActiveCar) {
                    card.querySelector('.open-wizard-btn').onclick = () => openWizard(car);
                }
                container.appendChild(card);
            });
        }

        // 指定時刻に車が予約されているか判定
        function isCarBookedAt(carId, time) {
            // マスタースケジュールチェック
            const car = MASTER_CARS.find(c => c.id === carId);
            const hour = time.getHours();
            if (car.baseSchedule.some(range => hour >= range[0] && hour < range[1])) return true;

            // ユーザー予約チェック
            return appState.bookings.some(b => 
                b.carId === carId && time >= new Date(b.start) && time < new Date(b.end)
            );
        }

        function openWizard(car) {
            if(appState.activeBooking) {
                showToast("既に利用中の車両があります", true);
                return;
            }
            appState.selectedCar = car;
            document.getElementById('wizard-car-img').src = car.image;
            document.getElementById('wizard-car-name').innerText = car.name;
            
            // リセット
            goToStep(1);
            selectTimeMode('now');
            document.querySelector('input[name="plan"][value="2"]').checked = true;
            updatePlan();
            
            document.getElementById('modal-booking-wizard').classList.add('active');
        }

        window.goToStep = function(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-content-${step}`).classList.remove('hidden');
            
            const dot1 = document.getElementById('step-dot-1');
            const dot2 = document.getElementById('step-dot-2');
            const line = document.getElementById('step-line-1');
            
            if(step === 2) {
                dot2.classList.replace('bg-gray-100', 'bg-primary');
                dot2.classList.replace('text-gray-400', 'text-white');
                line.style.width = '100%';
                renderScheduleBar();
            } else {
                dot2.classList.replace('bg-primary', 'bg-gray-100');
                dot2.classList.replace('text-white', 'text-gray-400');
                line.style.width = '0%';
            }
        };

        window.updatePlan = function() {
            const val = document.querySelector('input[name="plan"]:checked').value;
            appState.wizardPlanHours = parseFloat(val);
            renderScheduleBar();
            updateWizardTimeDisplay();
        };

        // イベントリスナ設定
        function setupInteractions() {
            document.querySelectorAll('input[name="plan"]').forEach(r => r.addEventListener('change', updatePlan));
            document.getElementById('btn-now').addEventListener('click', () => selectTimeMode('now'));
            document.getElementById('btn-later').addEventListener('click', () => selectTimeMode('later'));
            document.getElementById('input-start-time').addEventListener('change', (e) => {
                appState.wizardStartTime = new Date(e.target.value);
                renderScheduleBar();
                updateWizardTimeDisplay();
            });
            
            // モーダル外クリックで閉じる
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });
        }

        function selectTimeMode(mode) {
            const btnNow = document.getElementById('btn-now');
            const btnLater = document.getElementById('btn-later');
            const inputArea = document.getElementById('custom-time-input');
            
            if(mode === 'now') {
                btnNow.classList.add('border-secondary', 'bg-orange-50');
                btnNow.classList.remove('border-gray-200', 'bg-white');
                btnLater.classList.remove('border-secondary', 'bg-orange-50');
                inputArea.classList.add('hidden');
                
                const now = new Date();
                now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15, 0, 0); 
                appState.wizardStartTime = now;
            } else {
                btnLater.classList.add('border-secondary', 'bg-orange-50');
                btnLater.classList.remove('border-gray-200', 'bg-white');
                btnNow.classList.remove('border-secondary', 'bg-orange-50');
                inputArea.classList.remove('hidden');
                
                // input値同期
                const val = document.getElementById('input-start-time').value;
                if(val) appState.wizardStartTime = new Date(val);
            }
            renderScheduleBar();
            updateWizardTimeDisplay();
        }

        function updateWizardTimeDisplay() {
            const end = new Date(appState.wizardStartTime.getTime() + appState.wizardPlanHours * 60 * 60 * 1000);
            
            const fmt = (d) => `${d.getHours()}:${(d.getMinutes()<10?'0':'')+d.getMinutes()}`;
            document.getElementById('wizard-start-time').innerText = fmt(appState.wizardStartTime);
            document.getElementById('wizard-end-time').innerText = fmt(end);
        }

        function renderScheduleBar() {
            const container = document.getElementById('schedule-bar-container');
            container.innerHTML = '';
            
            const totalMin = 24 * 60;
            // 既存予約（マスター）
            appState.selectedCar.baseSchedule.forEach(range => {
                const s = range[0] * 60;
                const e = range[1] * 60;
                const el = document.createElement('div');
                el.className = 'schedule-segment booked absolute top-0 bottom-0';
                el.style.left = `${(s/totalMin)*100}%`;
                el.style.width = `${((e-s)/totalMin)*100}%`;
                container.appendChild(el);
            });

            // ユーザー予約
            appState.bookings.filter(b => b.carId === appState.selectedCar.id).forEach(b => {
                const start = new Date(b.start);
                const end = new Date(b.end);
                // 本日のもののみ簡易表示
                const s = start.getHours() * 60 + start.getMinutes();
                const e = end.getHours() * 60 + end.getMinutes();
                 const el = document.createElement('div');
                el.className = 'schedule-segment booked absolute top-0 bottom-0';
                el.style.left = `${(s/totalMin)*100}%`;
                el.style.width = `${((e-s)/totalMin)*100}%`;
                container.appendChild(el);
            });
            
            // 選択範囲
            const sH = appState.wizardStartTime.getHours();
            const sM = appState.wizardStartTime.getMinutes();
            const startTotal = sH * 60 + sM;
            const endTotal = startTotal + (appState.wizardPlanHours * 60);
            
            // 24時またぎの表示制限
            const dispStart = Math.max(0, startTotal);
            const dispEnd = Math.min(totalMin, endTotal);
            
            if(dispEnd > dispStart) {
                const el = document.createElement('div');
                el.className = 'schedule-segment selected absolute top-0 bottom-0';
                el.style.left = `${(dispStart/totalMin)*100}%`;
                el.style.width = `${((dispEnd-dispStart)/totalMin)*100}%`;
                container.appendChild(el);
            }
        }

        window.confirmBooking = function() {
            const start = appState.wizardStartTime;
            const end = new Date(start.getTime() + appState.wizardPlanHours * 60 * 60 * 1000);
            
            // 重複チェック
            // 簡易的に1時間ごとのチェックを行う
            let checkTime = new Date(start);
            while(checkTime < end) {
                if(isCarBookedAt(appState.selectedCar.id, checkTime)) {
                    showToast("選択した時間は既に予約が入っています", true);
                    return;
                }
                checkTime.setMinutes(checkTime.getMinutes() + 30); // 30分刻みで検査
            }

            closeModal('modal-booking-wizard');
            
            // ローディング演出
            setTimeout(() => {
                document.getElementById('modal-success').classList.add('active');
                
                // データ保存
                appState.activeBooking = {
                    carId: appState.selectedCar.id,
                    carName: appState.selectedCar.name,
                    startTime: start.getTime(),
                    endTime: end.getTime()
                };
                appState.bookings.push({
                    carId: appState.selectedCar.id,
                    start: start.getTime(),
                    end: end.getTime()
                });
                saveState();
            }, 500);
        };

        window.finishBookingProcess = function() {
            closeModal('modal-success');
            updateActiveBookingUI();
            renderCars();
            navigateTo('screen-home');
            showToast("いってらっしゃい！安全運転で。");
        };

        function updateActiveBookingUI() {
            const panel = document.getElementById('active-booking-panel');
            if(appState.activeBooking) {
                panel.classList.remove('hidden');
                document.getElementById('active-car-name').textContent = appState.activeBooking.carName;
                const end = new Date(appState.activeBooking.endTime);
                document.getElementById('active-end-time').textContent = `${end.getHours()}:${(end.getMinutes()<10?'0':'')+end.getMinutes()}`;
            } else {
                panel.classList.add('hidden');
            }
        }

        // --- 8. 返却 ---
        window.openReturnModal = function() {
             // チェックボックスリセット
             document.querySelectorAll('#modal-return input[type="checkbox"]').forEach(c => c.checked = false);
             document.getElementById('modal-return').classList.add('active');
        };

        window.openRewardModal = function() {
            document.getElementById('modal-rewards').classList.add('active');
        };

        window.completeReturn = function() {
            const checks = document.querySelectorAll('#modal-return input[type="checkbox"]');
            const allChecked = Array.from(checks).every(c => c.checked);
            
            if(!allChecked) {
                showToast("全ての確認項目をチェックしてください", true);
                return;
            }

            closeModal('modal-return');
            appState.activeBooking = null;
            saveState();
            
            updateActiveBookingUI();
            renderCars();
            showToast("返却完了しました。お疲れ様でした！");
        };

        // --- 9. その他モーダル・画面遷移 ---
        window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); };
        
        window.navigateTo = function(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Footer update
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const icon = btn.querySelector('i');
                if(btn.dataset.screen === screenId) {
                    btn.classList.add('text-primary');
                    btn.classList.remove('text-gray-400');
                    if(icon) icon.classList.add('-translate-y-1');
                } else {
                    btn.classList.remove('text-primary');
                    btn.classList.add('text-gray-400');
                    if(icon) icon.classList.remove('-translate-y-1');
                }
            });

            if(screenId === 'screen-home' && map) setTimeout(() => map.invalidateSize(), 300);
        };

        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => navigateTo(btn.dataset.screen));
            });
        }

        // スタンプQRシミュレーション
        window.simulateScanQR = function() {
            if(appState.stamps.every(s => s.earned)) {
                showToast("既にコンプリートしています！");
                return;
            }
            
            const nextIdx = appState.stamps.findIndex(s => !s.earned);
            if(nextIdx !== -1) {
                appState.stamps[nextIdx].earned = true;
                appState.stamps[nextIdx].date = 'Now';
                saveState();
                renderHome();
                showToast(`スタンプGET! (${nextIdx + 1}/9)`);
            }
        };

        // クーポン・報酬・お知らせ（表示ロジックのみ）
        function renderCoupons() {
            const activeC = document.getElementById('active-coupons');
            const usedC = document.getElementById('used-coupons');
            activeC.innerHTML = ''; usedC.innerHTML = '';
            
            appState.coupons.forEach(c => {
                const el = document.createElement('div');
                el.className = 'coupon-ticket bg-white flex rounded-lg overflow-hidden border border-gray-100 shadow-sm min-h-[100px] cursor-pointer';
                if(c.status === 'active') {
                    el.onclick = () => {
                        appState.selectedCoupon = c;
                        document.getElementById('modal-coupon-title').innerText = c.title;
                        document.getElementById('modal-use-coupon').classList.add('active');
                    };
                }
                el.innerHTML = `
                    <div class="w-1/3 bg-gray-50 flex flex-col items-center justify-center p-2 border-r border-dashed border-gray-300 relative">
                        <span class="text-xl font-bold text-ncu-green text-center leading-tight">${c.discount}</span>
                    </div>
                    <div class="w-2/3 p-3 flex flex-col justify-between">
                        <div><h4 class="font-bold text-gray-800 text-sm">${escapeHtml(c.title)}</h4><p class="text-[10px] text-gray-500">${escapeHtml(c.desc)}</p></div>
                        <div class="flex justify-between items-end mt-2"><span class="text-[10px] text-gray-400">期限: ${c.expire}</span>${c.status==='active'?'<span class="text-xs font-bold text-secondary">使う ></span>':'<span class="text-xs bg-gray-200 text-gray-500 font-bold px-2 py-0.5 rounded">使用済</span>'}</div>
                    </div>
                `;
                if(c.status==='active') activeC.appendChild(el); else usedC.appendChild(el);
            });
            
            document.querySelectorAll('.coupon-tab').forEach(btn => {
                btn.onclick = function() {
                    const t = this.dataset.target;
                    document.getElementById('active-coupons').classList.add('hidden');
                    document.getElementById('used-coupons').classList.add('hidden');
                    document.getElementById(t).classList.remove('hidden');
                    
                    document.querySelectorAll('.coupon-tab').forEach(b => {
                        b.classList.remove('bg-white', 'shadow-sm', 'text-primary');
                        b.classList.add('text-gray-500');
                    });
                    this.classList.add('bg-white', 'shadow-sm', 'text-primary');
                    this.classList.remove('text-gray-500');
                };
            });
            
            document.getElementById('btn-confirm-use-coupon').onclick = () => {
                if(appState.selectedCoupon) {
                    appState.selectedCoupon.status = 'used';
                    saveState();
                    renderCoupons();
                    closeModal('modal-use-coupon');
                    showToast('クーポンを使用しました');
                }
            };
        }

        function renderRewards() {
            const list = document.getElementById('reward-list');
            list.innerHTML = '';
            REWARD_DATA.forEach(r => {
                const el = document.createElement('div');
                el.className = 'flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition cursor-pointer';
                el.innerHTML = `
                    <div class="bg-gray-100 p-2 rounded-full mr-3"><i data-lucide="${r.icon}" class="w-5 h-5 text-gray-600"></i></div>
                    <div><h4 class="font-bold text-gray-800 text-sm">${escapeHtml(r.name)}</h4><p class="text-[10px] text-gray-500">${escapeHtml(r.desc)}</p></div>
                `;
                list.appendChild(el);
            });
        }

        function renderNews(filter = 'all') {
            const list = document.getElementById('news-list');
            list.innerHTML = '';
            const data = filter === 'all' ? NEWS_DATA : NEWS_DATA.filter(n => n.category === filter);
            
            data.forEach(n => {
                let catColor = n.category === 'event' ? 'bg-secondary' : (n.category === 'coupon' ? 'bg-pink-500' : (n.category === 'app' ? 'bg-blue-500' : 'bg-gray-500'));
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer active:scale-[0.99]';
                el.onclick = () => openNewsModal(n);
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] text-white font-bold px-2 py-0.5 rounded ${catColor}">${n.category.toUpperCase()}</span>
                        <span class="text-xs text-gray-400 font-mono">${n.date}</span>
                    </div>
                    <h4 class="text-sm font-bold text-gray-800 leading-snug">${escapeHtml(n.title)}</h4>
                `;
                list.appendChild(el);
            });

            document.querySelectorAll('.news-tab').forEach(btn => {
                btn.onclick = function() {
                    renderNews(this.dataset.filter);
                    document.querySelectorAll('.news-tab').forEach(b => {
                        b.classList.remove('bg-ncu-green', 'text-white', 'shadow-sm');
                        b.classList.add('bg-white', 'border', 'border-gray-200', 'text-gray-500');
                    });
                    this.classList.remove('bg-white', 'border', 'border-gray-200', 'text-gray-500');
                    this.classList.add('bg-ncu-green', 'text-white', 'shadow-sm');
                };
            });
        }
        
        function openNewsModal(news) {
            document.getElementById('news-modal-title').textContent = news.title;
            document.getElementById('news-modal-date').textContent = news.date;
            document.getElementById('news-modal-content').textContent = news.content;
            document.getElementById('modal-news-detail').classList.add('active');
        }

    </script>
</body>
</html>
